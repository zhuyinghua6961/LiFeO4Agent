<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç£·é…¸é“é”‚çŸ¥è¯†å›¾è°± AI åŠ©æ‰‹</title>
    <!-- SVG Favicon - ç®€å•çš„ç”µæ± å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='25' width='60' height='50' rx='5' fill='none' stroke='%23667eea' stroke-width='4'/><rect x='30' y='35' width='15' height='30' fill='%23667eea'/><rect x='55' y='35' width='15' height='30' fill='%23764ba2'/></svg>">
    <!-- å¼•å…¥marked.js - ä¸“ä¸šçš„Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§å†å²è®°å½• */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .clear-all-btn {
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .clear-all-btn:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* PDFä¸Šä¼ åŒºåŸŸ */
        .pdf-upload-section {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .pdf-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pdf-upload-box {
            position: relative;
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .pdf-upload-box:hover {
            border-color: #667eea;
            background: #f5f3ff;
        }

        .pdf-upload-box.has-file {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .pdf-upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .pdf-upload-text {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .pdf-upload-hint {
            font-size: 11px;
            color: #9ca3af;
        }

        .pdf-file-info {
            display: none;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }

        .pdf-file-info.active {
            display: block;
        }

        .pdf-file-name {
            font-size: 12px;
            color: #374151;
            margin-bottom: 8px;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pdf-remove-btn {
            width: 100%;
            padding: 6px;
            background: #fee2e2;
            color: #ef4444;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pdf-remove-btn:hover {
            background: #fecaca;
        }

        .pdf-mode-toggle {
            margin-top: 10px;
            display: none;
        }

        .pdf-mode-toggle.active {
            display: block;
        }

        .pdf-mode-label {
            font-size: 12px;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            background: white;
            transition: all 0.2s;
        }

        .pdf-mode-label:hover {
            background: #f3f4f6;
        }

        .pdf-mode-label input[type="checkbox"] {
            cursor: pointer;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item:hover {
            background: #f3f4f6;
        }

        .history-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 3px solid #667eea;
        }

        .history-title {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .history-delete {
            opacity: 0;
            transition: opacity 0.2s;
            margin-left: 8px;
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
        }

        .history-item:hover .history-delete {
            opacity: 1;
        }

        .history-delete:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        /* å³ä¾§ä¸»èŠå¤©åŒº */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #f5f7fa 0%, #e8eef5 100%);
        }

        .chat-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-right: 15px;
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .kb-info {
            font-size: 13px;
            color: #6b7280;
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .message {
            margin-bottom: 25px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-bot {
            display: flex;
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            position: relative;
        }

        .message-user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bot .message-content {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* æ‘˜å½•å°åœ†ç‚¹æ‚¬åœæç¤ºæ ·å¼ */
        .snippet-dot {
            display: inline-block;
            cursor: help;
            color: #667eea;
            font-size: 10px;
            vertical-align: middle;
            margin-left: 2px;
            position: relative;
        }
        .snippet-dot:hover::after {
            content: attr(data-snippet);
            position: absolute;
            left: 50%;
            bottom: 120%;
            transform: translateX(-50%);
            width: 320px;
            max-height: 200px;
            overflow-y: auto;
            background: #1f2937;
            color: #f3f4f6;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            pointer-events: none;
        }

        /* Markdownè¡¨æ ¼æ ·å¼ */
        .message-content .md-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #f9fafb;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content .md-table thead {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .message-content .md-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            font-size: 14px;
        }

        .message-content .md-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            font-size: 14px;
        }

        .message-content .md-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .message-content .md-table tr:last-child td {
            border-bottom: none;
        }

        /* Markdownæ ‡é¢˜æ ·å¼ */
        .message-content h1 {
            font-size: 20px;
            color: #667eea;
            margin: 20px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .message-content h2 {
            font-size: 18px;
            color: #667eea;
            margin: 18px 0 12px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        }

        .message-content h3 {
            font-size: 16px;
            color: #764ba2;
            margin: 15px 0 10px 0;
        }

        /* Markdownåˆ—è¡¨æ ·å¼ */
        .message-content ol,
        .message-content ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message-content li {
            margin: 6px 0;
            line-height: 1.6;
        }

        .message-content strong {
            color: #667eea;
            font-weight: 600;
        }

        /* æµå¼è¾“å‡ºå…‰æ ‡åŠ¨ç”» */
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #667eea;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        /* ğŸ¨ åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-animation {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            color: #667eea;
            font-size: 14px;
        }

        .loading-spinner {
            display: flex;
            gap: 5px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: loading-bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading-bounce {
            0%, 80%, 100% { 
                transform: scale(0);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-text {
            font-weight: 500;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: loading-pulse 2s ease-in-out infinite;
        }

        @keyframes loading-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .message-content blockquote {
            margin: 15px 0;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 4px solid #667eea;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #4b5563;
        }

        .message-content p {
            margin: 10px 0;
            line-height: 1.7;
        }

        /* Markdownä»£ç å—æ ·å¼ */
        .message-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            color: #e83e8c;
        }

        .message-content pre {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: #374151;
        }

        /* Markdowné“¾æ¥æ ·å¼ */
        .message-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            transition: all 0.2s;
        }

        .message-content a:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        /* Markdownæ°´å¹³çº¿ */
        .message-content hr {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 20px 0;
        }

        /* Markdownå›¾ç‰‡ */
        .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Markdownæ–œä½“ */
        .message-content em {
            font-style: italic;
            color: #6b7280;
        }

        .message-bot .bot-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .query-mode-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #667eea;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .references {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .references-title {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .reference-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            margin: 4px 4px 4px 0;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .reference-doi {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
        }

        .reference-doi:hover {
            text-decoration: underline;
        }

        .view-pdf-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .view-pdf-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .reference-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateY(-2px);
        }

        /* å¿«é€Ÿå»ºè®® */
        .suggestions-container {
            padding: 20px 30px;
            background: white;
            border-radius: 20px;
            margin: 20px 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .suggestions-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .suggestion-chip {
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 20px;
            color: #667eea;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-chip:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 12px 16px;
            transition: all 0.3s;
        }

        .input-wrapper:focus-within {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            font-size: 15px;
            color: #1f2937;
            font-family: inherit;
            outline: none;
            min-height: 24px;
            max-height: 120px;
        }

        textarea::placeholder {
            color: #9ca3af;
        }

        .send-btn {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* åŠ è½½åŠ¨ç”» - æ€è€ƒè¿‡ç¨‹ */
        .loading-message {
            display: flex;
            flex-direction: column;
            padding: 16px 20px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 300px;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .thinking-text {
            font-weight: 500;
            color: #667eea;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
            margin-left: 12px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .thinking-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .thinking-step {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #6b7280;
            opacity: 0.4;
            transition: all 0.3s;
        }

        .thinking-step.active {
            opacity: 1;
            color: #667eea;
            font-weight: 500;
        }

        .thinking-step.completed {
            opacity: 0.7;
            color: #10b981;
        }

        .step-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-icon::before {
            content: 'â—‹';
            font-size: 12px;
        }

        .thinking-step.active .step-icon::before {
            content: 'â—‰';
            animation: pulse 1.5s infinite;
        }

        .thinking-step.completed .step-icon::before {
            content: 'âœ“';
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 14px;
        }

        /* å“åº”å¼ */
        /* ğŸ“± å“åº”å¼è®¾è®¡ - å®Œæ•´ç‰ˆ */
        
        /* è¶…å¤§å±å¹• (>1920px) - 4Kæ˜¾ç¤ºå™¨ */
        @media (min-width: 1920px) {
            .main-chat {
                max-width: 1400px;
                margin: 0 auto;
            }
            
            .message-content {
                font-size: 16px;
                line-height: 1.8;
            }
        }
        
        /* å¤§å±å¹• (1200px - 1920px) - å¸¸è§„å°å¼æœº */
        @media (min-width: 1200px) and (max-width: 1919px) {
            .messages-area {
                padding: 30px;
            }
        }
        
        /* ä¸­ç­‰å±å¹• (768px - 1199px) - ç¬”è®°æœ¬/å¹³æ¿æ¨ªå± */
        @media (max-width: 1199px) {
            .sidebar {
                width: 240px;
            }
            
            .main-chat {
                margin-left: 240px;
            }
            
            .message-content {
                font-size: 14px;
            }
            
            .suggestions-container {
                padding: 15px;
            }
            
            .suggestion-chip {
                font-size: 12px;
                padding: 8px 14px;
            }
        }
        
        /* å°å±å¹• (481px - 767px) - å¹³æ¿ç«–å±/å¤§æ‰‹æœº */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 1000;
                width: 280px;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }

            .sidebar.open {
                left: 0;
            }
            
            .main-chat {
                margin-left: 0;
                width: 100%;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .header-title h1 {
                font-size: 18px;
            }
            
            .messages-area {
                padding: 15px;
            }
            
            .message {
                font-size: 14px;
            }
            
            .input-container {
                padding: 12px;
            }
            
            .message-input {
                font-size: 14px;
                padding: 10px;
            }
            
            /* è¡¨æ ¼åœ¨å°å±å¹•ä¸Šæ¨ªå‘æ»šåŠ¨ */
            .message-content table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .suggestion-chips {
                flex-direction: column;
                gap: 8px;
            }
            
            .suggestion-chip {
                width: 100%;
                text-align: center;
            }
            
            /* æ·»åŠ æ±‰å ¡èœå•æŒ‰é’® */
            .chat-header::before {
                content: 'â˜°';
                font-size: 24px;
                cursor: pointer;
                margin-right: 10px;
                padding: 5px 10px;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 8px;
            }
        }
        
        /* æå°å±å¹• (<480px) - æ‰‹æœºç«–å± */
        @media (max-width: 480px) {
            .header-title h1 {
                font-size: 16px;
            }
            
            .kb-info {
                font-size: 11px;
            }
            
            .message-content {
                font-size: 13px;
            }
            
            .query-mode-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
            
            .reference-item {
                font-size: 12px;
                padding: 8px;
            }
            
            .send-btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .empty-title {
                font-size: 18px;
            }
            
            .empty-desc {
                font-size: 13px;
            }
        }
        
        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 600px) {
            .chat-header {
                padding: 10px 20px;
            }
            
            .messages-area {
                padding: 15px 20px;
            }
            
            .input-container {
                padding: 10px 15px;
            }
        }
        
        /* é«˜DPIå±å¹•ä¼˜åŒ– (Retinaç­‰) */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .message-content {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
        /* ğŸ¨ PDFé˜…è¯»å™¨æ ·å¼ï¼ˆæ–°ç‰ˆ - PDF.js + ä¾§è¾¹ç¿»è¯‘ï¼‰ */
        #pdfReaderModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pdf-reader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            animation: fadeIn 0.3s;
        }
        
        .pdf-reader-container-new {
            position: relative;
            width: 95%;
            max-width: 1600px;
            height: 90vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        
        .pdf-reader-header-new {
            padding: 20px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }
        
        .pdf-reader-header-new h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .pdf-action-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .pdf-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .pdf-close-btn {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pdf-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .pdf-viewer-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: #f5f7fa;
        }
        
        /* å·¦ä¾§PDFæ˜¾ç¤ºåŒº */
        .pdf-viewer-left {
            width: 70%;
            display: flex;
            flex-direction: column;
            background: #e5e7eb;
            transition: width 0.3s ease;
        }
        
        /* iframe PDFå®¹å™¨ */
        .pdf-iframe-container {
            flex: 1;
            overflow: hidden;
            background: #525659;
            position: relative;
        }
        
        #pdfIframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* PDFå·¥å…·æ  */
        .pdf-toolbar {
            padding: 12px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pdf-summary-box {
            margin: 10px 20px 0 20px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            color: #166534;
            font-size: 14px;
            line-height: 1.5;
            max-height: 200px;
            overflow: auto;
        }
        .pdf-summary-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            color: #15803d;
        }
        .pdf-summary-loading {
            color: #0f172a;
            font-size: 13px;
            margin-top: 6px;
        }
        
        .toolbar-tip {
            font-size: 13px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .text-layer ::selection {
            background: rgba(102, 126, 234, 0.3);
        }
        
        /* PDFæ§åˆ¶æ  */
        .pdf-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .pdf-nav-btn, .pdf-zoom-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .pdf-nav-btn:hover, .pdf-zoom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        #pageInfo, #zoomLevel {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }
        
        /* å³ä¾§ç¿»è¯‘é¢æ¿ */
        .translation-panel {
            width: 30%;
            display: flex;
            flex-direction: column;
            background: white;
            border-left: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .translation-panel.hidden {
            width: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .translation-panel-header {
            padding: 20px;
            background: #f9fafb;
            border-bottom: 2px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .translation-panel-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 18px;
        }
        
        .panel-close-btn {
            background: transparent;
            border: none;
            font-size: 20px;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .panel-close-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .translation-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* ç¿»è¯‘æ¬¢è¿é¡µ */
        .translation-welcome {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .translation-welcome-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .translation-welcome h4 {
            color: #374151;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .translation-welcome p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .translation-tips {
            margin-top: 30px;
            text-align: left;
        }
        
        .tip-item {
            padding: 10px 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
        }
        
        /* ç¿»è¯‘é¡¹ */
        .translation-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            animation: slideInRight 0.4s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .translation-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 12px;
            color: #9ca3af;
        }
        
        .translation-item-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .translation-source, .translation-target {
            padding: 12px;
            background: white;
            border-radius: 8px;
        }
        
        .lang-label {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .translation-target .lang-label {
            color: #10b981;
        }
        
        .text-content {
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
        }
        
        .text-content.loading {
            color: #9ca3af;
            font-style: italic;
        }
        
        /* ç¿»è¯‘æ“ä½œæ ï¼ˆæ–°ç‰ˆ - æ”¯æŒè¾“å…¥æ¡†ï¼‰ */
        .translation-action-bar {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .translation-input-container {
            margin-bottom: 10px;
        }
        
        .translation-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s;
            background: white;
        }
        
        .translation-input.highlighted {
            border: 2px dashed #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }
        
        .translation-input:focus {
            outline: none;
            border-color: #667eea;
            border-style: solid;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }
        
        .translation-input::placeholder {
            color: #9ca3af;
            font-size: 13px;
        }
        
        .quick-tip {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.08);
            border-radius: 6px;
            font-size: 12px;
            color: #667eea;
            text-align: center;
        }
        
        .translation-buttons {
            display: flex;
            gap: 8px;
        }
        
        .translate-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .translate-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .translate-btn.secondary {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }
        
        .translate-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .translate-btn.secondary:hover:not(:disabled) {
            background: #e5e7eb;
            color: #374151;
        }
        
        .translate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .translate-btn.secondary.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #667eea;
            border-color: #667eea;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        .btn-text {
            font-size: 13px;
        }
        
        /* å¤§æŒ‰é’®æ ·å¼ */
        .translate-btn.large {
            width: 100%;
            padding: 18px 24px;
            font-size: 16px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .translate-btn.large:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .translate-btn.large .btn-icon {
            font-size: 24px;
        }
        
        .translate-btn.large .btn-text {
            font-size: 17px;
            font-weight: 700;
        }
        
        /* è„‰åŠ¨æ•ˆæœ */
        .translate-btn.pulse {
            animation: gentle-pulse 2s ease-in-out infinite;
        }
        
        @keyframes gentle-pulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5), 0 0 0 4px rgba(102, 126, 234, 0.1);
            }
        }
        
        .btn-shortcut {
            position: absolute;
            right: 20px;
            font-size: 11px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        /* åˆ†éš”çº¿ */
        .or-divider {
            text-align: center;
            margin: 15px 0;
            position: relative;
        }
        
        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 35%;
            height: 1px;
            background: #e5e7eb;
        }
        
        .or-divider::before {
            left: 0;
        }
        
        .or-divider::after {
            right: 0;
        }
        
        .or-divider span {
            color: #9ca3af;
            font-size: 12px;
            background: white;
            padding: 0 10px;
        }
        
        .pdf-loading-full {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #667eea;
        }
        
        .pdf-loading-full p {
            margin-top: 15px;
            font-size: 14px;
        }
        
        /* æµ®åŠ¨ç¿»è¯‘æŒ‰é’® */
        .floating-translate-btn {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }
        
        .floating-translate-btn button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .floating-translate-btn button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .floating-translate-btn button:active {
            transform: scale(0.95);
        }
        
        /* æ®µè½æç¤ºæ ·å¼ */
        .paragraph-hint {
            animation: fadeIn 0.5s;
        }
        
        /* é¦–æ¬¡æç¤ºæ ·å¼ */
        .first-time-hint {
            position: absolute;
            z-index: 1000;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… - æ–°ç‰ˆPDFé˜…è¯»å™¨ */
        @media (max-width: 768px) {
            .pdf-reader-container-new {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .pdf-reader-header-new {
                padding: 15px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .pdf-reader-header-new h2 {
                font-size: 16px;
            }
            
            .pdf-viewer-layout {
                flex-direction: column;
            }
            
            .pdf-viewer-left {
                width: 100% !important;
                height: 60%;
            }
            
            .translation-panel {
                width: 100%;
                height: 40%;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
            
            .translation-panel.hidden {
                height: 0;
            }
            
            .pdf-controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .pdf-nav-btn, .pdf-zoom-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§å†å²è®°å½• -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title-bar">
                    <div class="sidebar-title">ğŸ’¬ å¯¹è¯å†å²</div>
                    <button class="clear-all-btn" onclick="clearAllChats()" title="æ¸…ç©ºæ‰€æœ‰å¯¹è¯">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                </div>
                <button class="new-chat-btn" onclick="createNewChat()">
                    âœ¨ æ–°å»ºå¯¹è¯
                </button>
            </div>
            
            <!-- PDFä¸Šä¼ åŒºåŸŸ -->
            <div class="pdf-upload-section">
                <div class="pdf-section-title">
                    ğŸ“„ ä¸Šä¼ æ–‡çŒ®
                </div>
                <div class="pdf-upload-box" id="pdfUploadBox" onclick="document.getElementById('pdfFileInput').click()">
                    <div class="pdf-upload-icon">ğŸ“</div>
                    <div class="pdf-upload-text">ç‚¹å‡»ä¸Šä¼ PDFæ–‡çŒ®</div>
                    <div class="pdf-upload-hint">æ”¯æŒå¯¹æ–‡çŒ®å†…å®¹æé—®</div>
                    <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" onchange="handlePdfUpload(event)">
                </div>
                <div class="pdf-file-info" id="pdfFileInfo">
                    <div class="pdf-file-name" id="pdfFileName">
                        <span>ğŸ“„</span>
                        <span id="fileName"></span>
                    </div>
                    <div class="pdf-mode-toggle active">
                        <label class="pdf-mode-label">
                            <input type="checkbox" id="usePdfMode" checked>
                            <span>ç»“åˆæ–‡çŒ®å›ç­”é—®é¢˜</span>
                        </label>
                    </div>
                    <button class="pdf-remove-btn" onclick="removePdf()">
                        ğŸ—‘ï¸ ç§»é™¤æ–‡çŒ®
                    </button>
                </div>
            </div>
            
            <div class="chat-history" id="chatHistory">
                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>

        <!-- å³ä¾§ä¸»èŠå¤©åŒº -->
        <div class="main-chat">
            <!-- å¤´éƒ¨ -->
            <div class="chat-header">
                <div style="display: flex; align-items: center;">
                    <div class="ai-icon">âœ¨</div>
                    <div class="header-title">
                        <h1>ç£·é…¸é“é”‚çŸ¥è¯†å›¾è°± AI</h1>
                        <div class="kb-info" id="kbInfo">æ­£åœ¨è¿æ¥çŸ¥è¯†åº“...</div>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="messages-area" id="messagesArea">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ”‹</div>
                    <div class="empty-title">ä½ å¥½ï¼æˆ‘æ˜¯ç£·é…¸é“é”‚ææ–™ä¸“å®¶</div>
                    <div class="empty-desc">è¯·æå‡ºæ‚¨çš„é—®é¢˜ï¼Œæˆ‘å°†åŸºäºä¸“ä¸šçŸ¥è¯†åº“ä¸ºæ‚¨è§£ç­”</div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="é—®æˆ‘ä»»ä½•å…³äºç£·é…¸é“é”‚çš„é—®é¢˜..."
                        rows="1"
                        onkeydown="if(event.keyCode==13 && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let chats = [];
        let currentPdfFile = null;  // å½“å‰ä¸Šä¼ çš„PDFæ–‡ä»¶ä¿¡æ¯

        // é¡µé¢åŠ è½½
        window.onload = function() {
            // æ£€æŸ¥marked.jsæ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof marked === 'undefined') {
                console.warn('marked.jsæœªåŠ è½½ï¼ŒMarkdownæ¸²æŸ“å¯èƒ½å—é™');
            } else {
                console.log('âœ… marked.jsåŠ è½½æˆåŠŸï¼ŒMarkdownæ¸²æŸ“å·²å¯ç”¨');
            }
            
            fetchKbInfo();
            loadChats();
            createNewChat();
            
            // ğŸ“± ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
            initMobileSidebar();
        };
        
        // ğŸ“± ç§»åŠ¨ç«¯ä¾§è¾¹æ åŠŸèƒ½
        function initMobileSidebar() {
            const chatHeader = document.querySelector('.chat-header');
            const sidebar = document.querySelector('.sidebar');
            const mainChat = document.querySelector('.main-chat');
            
            // ç‚¹å‡»å¤´éƒ¨çš„æ±‰å ¡èœå•
            chatHeader.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && e.target === chatHeader) {
                    sidebar.classList.toggle('open');
                }
            });
            
            // ç‚¹å‡»ä¸»èŠå¤©åŒºåŸŸå…³é—­ä¾§è¾¹æ 
            mainChat.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                    if (!sidebar.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            });
            
            // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('open');
                }
            });
        }

        // PDFä¸Šä¼ å¤„ç†
        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('è¯·ä¸Šä¼ PDFæ–‡ä»¶ï¼');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadBox = document.getElementById('pdfUploadBox');
            uploadBox.innerHTML = '<div class="pdf-upload-icon">â³</div><div class="pdf-upload-text">ä¸Šä¼ ä¸­...</div>';

            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload_pdf', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    alert('ä¸Šä¼ å¤±è´¥ï¼š' + data.error);
                    resetPdfUploadBox();
                    return;
                }

                // ä¿å­˜PDFä¿¡æ¯
                currentPdfFile = {
                    name: file.name,
                    path: data.filepath,
                    uploadTime: new Date().toLocaleString()
                };

                // æ›´æ–°UI
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('pdfFileInfo').classList.add('active');
                uploadBox.classList.add('has-file');
                uploadBox.innerHTML = '<div class="pdf-upload-icon">âœ…</div><div class="pdf-upload-text">æ–‡çŒ®å·²ä¸Šä¼ </div><div class="pdf-upload-hint">' + file.name + '</div>';

                // åœ¨å½“å‰å¯¹è¯ä¸­æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                if (currentChatId) {
                    const chat = chats.find(c => c.id === currentChatId);
                    if (chat) {
                        chat.messages.push({
                            type: 'system',
                            content: `ğŸ“„ å·²ä¸Šä¼ æ–‡çŒ®ï¼š${file.name}`
                        });
                        saveChats();
                        renderMessages();
                    }
                }

            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                resetPdfUploadBox();
            }
        }

        // ç§»é™¤PDF
        async function removePdf() {
            if (!confirm('ç¡®å®šè¦ç§»é™¤å½“å‰æ–‡çŒ®å—ï¼Ÿ')) {
                return;
            }

            // è°ƒç”¨åç«¯æ¥å£æ¸…é™¤PDF
            try {
                await fetch('/clear_pdf', {
                    method: 'POST'
                });
            } catch (error) {
                console.error('æ¸…é™¤PDFå¤±è´¥:', error);
            }

            currentPdfFile = null;
            resetPdfUploadBox();
            document.getElementById('pdfFileInfo').classList.remove('active');
            document.getElementById('pdfFileInput').value = '';

            // åœ¨å½“å‰å¯¹è¯ä¸­æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            if (currentChatId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages.push({
                        type: 'system',
                        content: 'ğŸ“„ å·²ç§»é™¤æ–‡çŒ®'
                    });
                    saveChats();
                    renderMessages();
                }
            }
        }

        // é‡ç½®ä¸Šä¼ æ¡†
        function resetPdfUploadBox() {
            const uploadBox = document.getElementById('pdfUploadBox');
            uploadBox.classList.remove('has-file');
            uploadBox.innerHTML = '<div class="pdf-upload-icon">ğŸ“</div><div class="pdf-upload-text">ç‚¹å‡»ä¸Šä¼ PDFæ–‡çŒ®</div><div class="pdf-upload-hint">æ”¯æŒå¯¹æ–‡çŒ®å†…å®¹æé—®</div><input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" onchange="handlePdfUpload(event)">';
        }

        // è·å–çŸ¥è¯†åº“ä¿¡æ¯
        function fetchKbInfo() {
            fetch('http://localhost:8000/api/kb_info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('kbInfo').textContent = 
                            `çŸ¥è¯†åº“ï¼š${data.kb_size} æ¡ | Neo4j: ${data.source_stats.neo4j} | ChromaDB: ${data.source_stats.chromadb}`;
                    }
                })
                .catch(() => {
                    document.getElementById('kbInfo').textContent = 'çŸ¥è¯†åº“è¿æ¥å¤±è´¥';
                });
        }

        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // åˆ›å»ºæ–°å¯¹è¯
        async function createNewChat() {
            // æ¸…é™¤PDFæ–‡ä»¶ï¼ˆå‰ç«¯å’Œåç«¯ï¼‰
            if (currentPdfFile) {
                try {
                    await fetch('/clear_pdf', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('æ¸…é™¤PDFå¤±è´¥:', error);
                }
                currentPdfFile = null;
                resetPdfUploadBox();
                document.getElementById('pdfFileInfo').classList.remove('active');
                document.getElementById('pdfFileInput').value = '';
            }

            const chat = {
                id: Date.now().toString(),
                title: 'æ–°å¯¹è¯',
                messages: [],
                createdAt: new Date()
            };
            chats.unshift(chat);
            currentChatId = chat.id;
            saveChats();
            renderChats();
            renderMessages();
        }

        // ä½¿ç”¨å»ºè®®
        function useSuggestion(text) {
            document.getElementById('messageInput').value = text;
            document.getElementById('messageInput').focus();
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            // â­ å¦‚æœå·²æœ‰æµå¼è¾“å‡ºåœ¨è¿›è¡Œï¼Œå…ˆä¸­æ–­
            if (isStreaming && currentStreamReader) {
                stopStreaming();
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ä¸­æ–­å®Œæˆ
                setTimeout(() => {
                    sendMessage();
                }, 100);
                return;
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                console.log('âŒ æ¶ˆæ¯ä¸ºç©º');
                return;
            }

            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                console.error('âŒ æ²¡æœ‰æ¿€æ´»çš„å¯¹è¯ï¼ŒcurrentChatId:', currentChatId);
                alert('è¯·å…ˆåˆ›å»ºæ–°å¯¹è¯ï¼');
                createNewChat();
                return;
            }
            
            console.log('âœ… å‡†å¤‡å‘é€æ¶ˆæ¯:', message);

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            chat.messages.push({
                role: 'user',
                content: message,
                timestamp: new Date()
            });

            // æ›´æ–°æ ‡é¢˜
            if (chat.messages.length === 1) {
                chat.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
            }

            input.value = '';
            input.style.height = 'auto';
            saveChats();
            renderChats();
            renderMessages();

            // ç¦ç”¨å‘é€æŒ‰é’®ï¼ˆç¨åä¼šåœ¨æµå¼è¾“å‡ºæ—¶æ”¹ä¸ºåœæ­¢æŒ‰é’®ï¼‰
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            // ğŸ”„ è·å–å¯¹è¯å†å²ï¼ˆæœ€è¿‘5è½®å¯¹è¯ï¼‰
            const chatHistory = chat.messages.slice(-10).map(msg => ({
                role: msg.role,
                content: msg.content
            }));
            
            const usePdf = document.getElementById('usePdfMode').checked && currentPdfFile;
            
            // â­ é»˜è®¤ä½¿ç”¨æµå¼è¾“å‡ºæ¨¡å¼ï¼ˆæ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼‰
            console.log('ğŸ’¬ ä½¿ç”¨æµå¼è¾“å‡ºæ¨¡å¼');
            sendMessageStream(message, chatHistory, usePdf, chat, sendBtn);
        }

        // å…¨å±€å˜é‡ï¼šä¿å­˜å½“å‰çš„æµå¼è¯»å–å™¨ï¼Œç”¨äºä¸­æ–­
        let currentStreamReader = null;
        let isStreaming = false;

        // ä¸­æ–­å½“å‰æµå¼è¾“å‡º
        function stopStreaming() {
            if (currentStreamReader && isStreaming) {
                console.log('ğŸ›‘ ç”¨æˆ·ä¸­æ–­å¯¹è¯');
                currentStreamReader.cancel();
                currentStreamReader = null;
                isStreaming = false;
                
                // æ¢å¤å‘é€æŒ‰é’®
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'â¤';
                sendBtn.onclick = sendMessage;
                
                // æ ‡è®°å½“å‰æµå¼æ¶ˆæ¯ä¸ºå·²ä¸­æ–­
                const chat = chats.find(c => c.id === currentChatId);
                if (chat && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    if (lastMessage.streaming) {
                        lastMessage.streaming = false;
                        if (lastMessage.content) {
                            lastMessage.content += '\n\n[å¯¹è¯å·²ä¸­æ–­]';
                        } else {
                            lastMessage.content = '[å¯¹è¯å·²ä¸­æ–­]';
                        }
                        saveChats();
                        renderMessages();
                    }
                }
            }
        }

        // æµå¼æ¨¡å¼å‘é€æ¶ˆæ¯
        function sendMessageStream(message, chatHistory, usePdf, chat, sendBtn) {
            console.log('ğŸ’¬ å¯åŠ¨æµå¼è¾“å‡º...');
            
            // â­ å¦‚æœå·²æœ‰æµå¼è¾“å‡ºåœ¨è¿›è¡Œï¼Œå…ˆä¸­æ–­
            if (isStreaming && currentStreamReader) {
                stopStreaming();
            }
            
            // æ ‡è®°ä¸ºæµå¼è¾“å‡ºä¸­
            isStreaming = true;
            
            // æ›´æ–°å‘é€æŒ‰é’®ä¸º"åœæ­¢"æŒ‰é’®
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'â¹';
            sendBtn.onclick = stopStreaming;
            sendBtn.title = 'åœæ­¢ç”Ÿæˆ';
            
            // åˆ›å»ºä¸€ä¸ªç©ºçš„botæ¶ˆæ¯ï¼Œç”¨äºé€æ­¥å¡«å……
            const botMessage = {
                role: 'bot',
                content: '',
                references: [],
                queryMode: '',
                timestamp: new Date(),
                streaming: true,  // æ ‡è®°ä¸ºæµå¼æ¶ˆæ¯
                messageId: 'streaming-' + Date.now()  // æ·»åŠ å”¯ä¸€ID
            };
            chat.messages.push(botMessage);
            
            // æ¸²æŸ“æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºç©ºçš„botæ¶ˆæ¯æ¡†ï¼‰
            saveChats();
            renderMessages();
            
            // è·å–åˆšåˆ›å»ºçš„æ¶ˆæ¯å…ƒç´ çš„å†…å®¹åŒºåŸŸ
            const messageArea = document.getElementById('messagesArea');
            const streamingElement = messageArea.querySelector('.message-bot:last-child .message-content');
            
            // ğŸ¨ æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            if (streamingElement) {
                streamingElement.innerHTML = `
                    <div class="loading-animation">
                        <div class="loading-spinner">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                        <span class="loading-text">æ­£åœ¨æ€è€ƒä¸­...</span>
                    </div>
                `;
            }
            
            // æ„å»ºè¯·æ±‚ä½“
            const requestBody = {
                question: message,
                use_pdf: usePdf,
                pdf_path: usePdf ? currentPdfFile.path : null,
                chat_history: chatHistory
            };
            
            // ä½¿ç”¨fetchå‘é€POSTè¯·æ±‚åˆ°æµå¼API
            fetch('http://localhost:8000/api/ask_stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                }
                
                const reader = response.body.getReader();
                currentStreamReader = reader;  // â­ ä¿å­˜readerå¼•ç”¨ï¼Œç”¨äºä¸­æ–­
                const decoder = new TextDecoder();
                let buffer = '';
                
                function readStream() {
                    // â­ æ£€æŸ¥æ˜¯å¦å·²è¢«ä¸­æ–­
                    if (!isStreaming) {
                        console.log('ğŸ›‘ æµå¼è¾“å‡ºå·²ä¸­æ–­');
                        return;
                    }
                    
                    reader.read().then(({ done, value }) => {
                        // â­ å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²è¢«ä¸­æ–­
                        if (!isStreaming) {
                            console.log('ğŸ›‘ æµå¼è¾“å‡ºå·²ä¸­æ–­ï¼ˆè¯»å–ä¸­ï¼‰');
                            return;
                        }
                        
                        if (done) {
                            console.log('âœ… æµå¼è¾“å‡ºå®Œæˆ');
                            botMessage.streaming = false;
                            isStreaming = false;
                            currentStreamReader = null;
                            
                            // æ¢å¤å‘é€æŒ‰é’®
                            sendBtn.disabled = false;
                            sendBtn.innerHTML = 'â¤';
                            sendBtn.onclick = sendMessage;
                            sendBtn.title = 'å‘é€';
                            
                            saveChats();
                            // â­ æµç»“æŸæ—¶æ¸²æŸ“ä¸€æ¬¡ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
                            renderMessages();
                            return;
                        }
                        
                        // è§£ç æ•°æ®
                        buffer += decoder.decode(value, { stream: true });
                        
                        // å¤„ç†SSEæ ¼å¼çš„æ•°æ®ï¼ˆä»¥\n\nåˆ†éš”ï¼‰
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop() || '';  // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                        
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                const jsonData = line.substring(6);
                                try {
                                    const data = JSON.parse(jsonData);
                                    
                                    if (data.type === 'start') {
                                        console.log('ğŸš€ å¼€å§‹ç”Ÿæˆç­”æ¡ˆ');
                                        // ğŸ¨ æ›´æ–°åŠ è½½åŠ¨ç”»æ–‡æœ¬
                                        if (streamingElement) {
                                            streamingElement.innerHTML = `
                                                <div class="loading-animation">
                                                    <div class="loading-spinner">
                                                        <div class="loading-dot"></div>
                                                        <div class="loading-dot"></div>
                                                        <div class="loading-dot"></div>
                                                    </div>
                                                    <span class="loading-text">ğŸ” æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...</span>
                                                </div>
                                            `;
                                        }
                                    } else if (data.type === 'thinking') {
                                        // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼ˆå¯é€‰ï¼‰
                                        console.log('ğŸ’­', data.content);
                                    } else if (data.type === 'metadata') {
                                        botMessage.queryMode = data.query_mode;
                                        console.log('ğŸ“Š æŸ¥è¯¢æ¨¡å¼:', data.query_mode);
                                        
                                        // ğŸ¨ æ›´æ–°åŠ è½½åŠ¨ç”»æ–‡æœ¬ - å·²æ‰¾åˆ°æ•°æ®ï¼Œå‡†å¤‡ç”Ÿæˆ
                                        if (streamingElement) {
                                            streamingElement.innerHTML = `
                                                <div class="loading-animation">
                                                    <div class="loading-spinner">
                                                        <div class="loading-dot"></div>
                                                        <div class="loading-dot"></div>
                                                        <div class="loading-dot"></div>
                                                    </div>
                                                    <span class="loading-text">âœ¨ æ­£åœ¨ç”Ÿæˆç­”æ¡ˆ...</span>
                                                </div>
                                            `;
                                        }
                                    } else if (data.type === 'content') {
                                        // â­ åªæ›´æ–°å†…å®¹ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢
                                        botMessage.content += data.content;
                                        
                                        // ç›´æ¥æ›´æ–°DOMï¼Œé¿å…é—ªçƒ
                                        if (streamingElement) {
                                            const modeBadge = botMessage.queryMode ? 
                                                `<div class="query-mode-badge">${botMessage.queryMode}</div>` : '';
                                            streamingElement.innerHTML = modeBadge + 
                                                formatAnswer(botMessage.content);
                                            
                                            // ğŸ¯ æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
                                            const isNearBottom = messageArea.scrollHeight - messageArea.scrollTop - messageArea.clientHeight < 100;
                                            if (isNearBottom) {
                                                messageArea.scrollTop = messageArea.scrollHeight;
                                            }
                                        }
                                    } else if (data.type === 'done') {
                                        console.log('âœ… æ¥æ”¶å®Œæˆ');
                                        botMessage.references = data.references || [];
                                        botMessage.referenceSnippets = data.reference_snippets || [];
                                        // â­ å¦‚æœåç«¯è¿”å›äº†å¸¦DOIçš„å®Œæ•´ç­”æ¡ˆï¼Œç”¨å®ƒæ›¿æ¢æµå¼å†…å®¹
                                        if (data.final_answer) {
                                            botMessage.content = data.final_answer;
                                            console.log('âœ… ä½¿ç”¨ç¨‹åºåŒ–æ’å…¥DOIåçš„ç­”æ¡ˆ');
                                        }
                                        botMessage.streaming = false;
                                        isStreaming = false;
                                        currentStreamReader = null;
                                        
                                        // æ¢å¤å‘é€æŒ‰é’®
                                        sendBtn.disabled = false;
                                        sendBtn.innerHTML = 'â¤';
                                        sendBtn.onclick = sendMessage;
                                        sendBtn.title = 'å‘é€';
                                        
                                        saveChats();
                                        // â­ åªåœ¨æœ€åå®Œæˆæ—¶æ¸²æŸ“ä¸€æ¬¡ï¼Œæ˜¾ç¤ºå®Œæ•´å†…å®¹å’Œå¼•ç”¨
                                        renderMessages();
                                    } else if (data.type === 'error') {
                                        console.error('âŒ é”™è¯¯:', data.error);
                                        botMessage.content = 'æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š' + data.error;
                                        botMessage.streaming = false;
                                        isStreaming = false;
                                        currentStreamReader = null;
                                        
                                        // æ¢å¤å‘é€æŒ‰é’®
                                        sendBtn.disabled = false;
                                        sendBtn.innerHTML = 'â¤';
                                        sendBtn.onclick = sendMessage;
                                        sendBtn.title = 'å‘é€';
                                        
                                        saveChats();
                                        renderMessages();
                                    }
                                } catch (e) {
                                    console.error('è§£æJSONå¤±è´¥:', e, jsonData);
                                }
                            }
                        });
                        
                        // ç»§ç»­è¯»å–ï¼ˆå¦‚æœæœªè¢«ä¸­æ–­ï¼‰
                        if (isStreaming) {
                            readStream();
                        }
                    }).catch(error => {
                        // â­ å¦‚æœæ˜¯ä¸­æ–­å¯¼è‡´çš„é”™è¯¯ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        if (error.name === 'AbortError' || !isStreaming) {
                            console.log('ğŸ›‘ æµå¼è¾“å‡ºå·²ä¸­æ–­');
                            return;
                        }
                        
                        console.error('âŒ æµå¼è¯»å–é”™è¯¯:', error);
                        botMessage.content = 'æŠ±æ­‰ï¼Œè¿æ¥ä¸­æ–­ï¼š' + error.message;
                        botMessage.streaming = false;
                        isStreaming = false;
                        currentStreamReader = null;
                        
                        // æ¢å¤å‘é€æŒ‰é’®
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = 'â¤';
                        sendBtn.onclick = sendMessage;
                        sendBtn.title = 'å‘é€';
                        
                        saveChats();
                        renderMessages();
                    });
                }
                
                readStream();
            })
            .catch(error => {
                console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
                botMessage.content = 'æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼š' + error.message;
                botMessage.streaming = false;
                isStreaming = false;
                currentStreamReader = null;
                
                // æ¢å¤å‘é€æŒ‰é’®
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'â¤';
                sendBtn.onclick = sendMessage;
                sendBtn.title = 'å‘é€';
                
                saveChats();
                renderMessages();
            });
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages() {
            const chat = chats.find(c => c.id === currentChatId);
            const area = document.getElementById('messagesArea');
            
            if (!chat || chat.messages.length === 0) {
                area.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ”‹</div>
                        <div class="empty-title">ä½ å¥½ï¼æˆ‘æ˜¯ç£·é…¸é“é”‚ææ–™ä¸“å®¶</div>
                        <div class="empty-desc">è¯·æå‡ºæ‚¨çš„é—®é¢˜ï¼Œæˆ‘å°†åŸºäºä¸“ä¸šçŸ¥è¯†åº“ä¸ºæ‚¨è§£ç­”</div>
                    </div>
                `;
                return;
            }

            let html = '';
            chat.messages.forEach(msg => {
                if (msg.type === 'system') {
                    // ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚PDFä¸Šä¼ é€šçŸ¥ï¼‰
                    html += `
                        <div class="message message-system" style="text-align: center; color: #6b7280; font-size: 13px; margin: 15px 0;">
                            ${escapeHtml(msg.content)}
                        </div>
                    `;
                } else if (msg.role === 'user') {
                    html += `
                        <div class="message message-user">
                            <div class="message-content">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                } else {
                    // æ·»åŠ æ•°æ®ç»Ÿè®¡ä¿¡æ¯
                    let dataStats = '';
                    if (msg.metadata && msg.metadata.result_count > 0) {
                        dataStats = `<div style="background: #f0f9ff; border-left: 3px solid #3b82f6; padding: 8px 12px; margin: 10px 0; border-radius: 6px; font-size: 13px; color: #1e40af;">
                            ğŸ“Š æŸ¥è¯¢ç»Ÿè®¡ï¼šå…±æ‰¾åˆ° <strong>${msg.metadata.result_count}</strong> æ¡æ•°æ®
                            ${msg.metadata.phase1_count > 0 ? `ï¼ˆç¬¬ä¸€é˜¶æ®µç­›é€‰ï¼š${msg.metadata.phase1_count}æ¡ï¼‰` : ''}
                        </div>`;
                    }

                    html += `
                        <div class="message message-bot">
                            <div class="bot-avatar">âœ¨</div>
                            <div class="message-content">
                                ${msg.queryMode ? `<div class="query-mode-badge">${msg.queryMode}</div>` : ''}
                                ${dataStats}
                                ${formatAnswer(msg.content, msg.referenceSnippets)}
                            </div>
                        </div>
                    `;
                }
            });

            area.innerHTML = html;
            area.scrollTop = area.scrollHeight;
        }

        // æ ¼å¼åŒ–ç­”æ¡ˆ - ä½¿ç”¨marked.jsä¸“ä¸šæ¸²æŸ“Markdown (å¸¦å®Œæ•´é™çº§æ–¹æ¡ˆ)
        // referenceSnippets å¯é€‰ï¼Œç”¨äºåœ¨ DOI æ—æ˜¾ç¤ºæ‘˜å½•å°åœ†ç‚¹
        function formatAnswer(text, referenceSnippets) {
            // é¢„å¤„ç†ï¼šæ¸…ç†LaTeXæ ¼å¼å¹¶å°†DOIè½¬ä¸ºå¯ç‚¹å‡»é“¾æ¥
            text = cleanLaTeXFormulas(text);
            text = linkifyDOI(text, referenceSnippets);
            
            // æ–¹æ¡ˆ1: å°è¯•ä½¿ç”¨marked.js (å¦‚æœå¯ç”¨)
            if (typeof marked !== 'undefined') {
                try {
                    // é…ç½®marked.jsé€‰é¡¹
                    marked.setOptions({
                        breaks: true,        // æ”¯æŒGitHubé£æ ¼çš„æ¢è¡Œ
                        gfm: true,          // å¯ç”¨GitHub Flavored Markdown
                        tables: true,       // æ”¯æŒè¡¨æ ¼
                        smartLists: true,   // æ™ºèƒ½åˆ—è¡¨
                        smartypants: true,  // æ™ºèƒ½æ ‡ç‚¹
                    });
                    
                    // ä½¿ç”¨markedæ¸²æŸ“Markdown
                    let html = marked.parse(text);
                    
                    // åå¤„ç†ï¼šç¡®ä¿æ ‡é¢˜æ ¼å¼æ­£ç¡®
                    html = fixMarkdownRendering(html);
                    
                    // ä¸ºè¡¨æ ¼æ·»åŠ è‡ªå®šä¹‰classï¼ˆä¿æŒåŸæœ‰æ ·å¼ï¼‰
                    html = html.replace(/<table>/g, '<table class="md-table">');
                    
                    return html;
                } catch (error) {
                    console.error('marked.jsæ¸²æŸ“å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
                }
            } else {
                console.warn('âš ï¸ marked.jsæœªåŠ è½½ï¼Œä½¿ç”¨å†…ç½®Markdownè§£æå™¨');
            }
            
            // æ–¹æ¡ˆ2: ä½¿ç”¨å†…ç½®çš„ç®€æ˜“Markdownè§£æå™¨ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
            return parseMarkdownFallback(text);
        }
        
        // å°†(doi=...)è½¬ä¸ºå¯ç‚¹å‡»é“¾æ¥ï¼Œä¿æŒåŸæœ‰æ‹¬å·ä½ç½®
        // å¦‚æœæœ‰ referenceSnippets ä¼šåœ¨æ—è¾¹åŠ ä¸€ä¸ªå°åœ†ç‚¹ï¼Œæ‚¬åœæ˜¾ç¤ºæ‘˜å½•
        function linkifyDOI(text, referenceSnippets) {
            if (!text) return text;
            const doiRegex = /\(doi=([^\s\)]+)\)/gi;
            return text.replace(doiRegex, (match, doi) => {
                const safeDoi = doi.replace(/"/g, '');
                const openFn = `openPdfReader('${safeDoi}'); return false;`;
                // æŸ¥æ‰¾è¯¥ DOI å¯¹åº”çš„æ‘˜å½•
                let snippetDot = '';
                if (referenceSnippets && referenceSnippets.length > 0) {
                    const found = referenceSnippets.find(s => s.doi === safeDoi);
                    if (found && found.snippet) {
                        // æˆªå–å‰300å­—ç¬¦ï¼Œè½¬ä¹‰HTML
                        const shortSnippet = found.snippet.length > 300 ? found.snippet.substring(0, 300) + '...' : found.snippet;
                        const escaped = shortSnippet.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, ' ');
                        snippetDot = ` <span class="snippet-dot" data-snippet="${escaped}">â—</span>`;
                    }
                }
                return `(<a href="#" onclick="${openFn}">doi=${safeDoi}</a> Â· <a href="#" onclick="${openFn}">æŸ¥çœ‹åŸæ–‡</a>${snippetDot})`;
            });
        }
        
        // æ¸…ç†LaTeXå…¬å¼ï¼Œè½¬æ¢ä¸ºçº¯æ–‡æœ¬æ ¼å¼
        function cleanLaTeXFormulas(text) {
            // ç§»é™¤å—çº§LaTeXå…¬å¼ \[...\] å’Œ $$...$$
            text = text.replace(/\\\[[\s\S]*?\\\]/g, function(match) {
                // æå–å…¬å¼å†…å®¹ï¼Œæ¸…ç†LaTeXå‘½ä»¤
                let formula = match.replace(/\\\[|\]/g, '').trim();
                formula = cleanLaTeXCommands(formula);
                return formula;
            });
            text = text.replace(/\$\$[\s\S]*?\$\$/g, function(match) {
                let formula = match.replace(/\$\$/g, '').trim();
                formula = cleanLaTeXCommands(formula);
                return formula;
            });
            
            // ç§»é™¤è¡Œå†…LaTeXå…¬å¼ \(...\) å’Œ $...$
            text = text.replace(/\\\([\s\S]*?\\\)/g, function(match) {
                let formula = match.replace(/\\\(|\\\)/g, '').trim();
                formula = cleanLaTeXCommands(formula);
                return formula;
            });
            text = text.replace(/\$[^$]+\$/g, function(match) {
                let formula = match.replace(/\$/g, '').trim();
                formula = cleanLaTeXCommands(formula);
                return formula;
            });
            
            return text;
        }
        
        // æ¸…ç†LaTeXå‘½ä»¤ï¼Œè½¬æ¢ä¸ºçº¯æ–‡æœ¬
        function cleanLaTeXCommands(text) {
            // å¤„ç† \text{...} -> æå–æ–‡æœ¬å†…å®¹
            text = text.replace(/\\text\{([^}]+)\}/g, '$1');
            
            // å¤„ç†ä¸‹æ ‡ _ -> Unicodeä¸‹æ ‡æˆ–æ™®é€šæ–‡æœ¬
            text = text.replace(/_(\d+)/g, function(match, num) {
                const subscripts = {'0': 'â‚€', '1': 'â‚', '2': 'â‚‚', '3': 'â‚ƒ', '4': 'â‚„', '5': 'â‚…', '6': 'â‚†', '7': 'â‚‡', '8': 'â‚ˆ', '9': 'â‚‰'};
                return num.split('').map(d => subscripts[d] || d).join('');
            });
            
            // å¤„ç†ä¸Šæ ‡ ^ -> Unicodeä¸Šæ ‡æˆ–æ™®é€šæ–‡æœ¬
            text = text.replace(/\^(\d+)/g, function(match, num) {
                const superscripts = {'0': 'â°', '1': 'Â¹', '2': 'Â²', '3': 'Â³', '4': 'â´', '5': 'âµ', '6': 'â¶', '7': 'â·', '8': 'â¸', '9': 'â¹'};
                return num.split('').map(d => superscripts[d] || d).join('');
            });
            
            // å¤„ç†ç®­å¤´å‘½ä»¤
            text = text.replace(/\\rightarrow/g, 'â†’');
            text = text.replace(/\\leftarrow/g, 'â†');
            text = text.replace(/\\leftrightarrow/g, 'â†”');
            text = text.replace(/\\Rightarrow/g, 'â‡’');
            text = text.replace(/\\Leftarrow/g, 'â‡');
            text = text.replace(/\\Leftrightarrow/g, 'â‡”');
            
            // ç§»é™¤å…¶ä»–LaTeXå‘½ä»¤ï¼ˆä¿ç•™å†…å®¹ï¼‰
            text = text.replace(/\\[a-zA-Z]+\{([^}]+)\}/g, '$1');
            text = text.replace(/\\[a-zA-Z]+/g, '');
            
            // æ¸…ç†å¤šä½™çš„ç©ºæ ¼
            text = text.replace(/\s+/g, ' ').trim();
            
            return text;
        }
        
        // ä¿®å¤Markdownæ¸²æŸ“é—®é¢˜ï¼ˆæ ‡é¢˜ã€æ®µè½ç­‰ï¼‰
        function fixMarkdownRendering(html) {
            // ç¡®ä¿æ ‡é¢˜å‰åæœ‰é€‚å½“çš„é—´è·
            html = html.replace(/<\/h([1-6])>/g, '</h$1>\n');
            html = html.replace(/<h([1-6])[^>]*>/g, '\n<h$1>');
            
            // ç¡®ä¿åˆ—è¡¨å‰åæœ‰é€‚å½“çš„é—´è·
            html = html.replace(/<\/ul>/g, '</ul>\n');
            html = html.replace(/<\/ol>/g, '</ol>\n');
            html = html.replace(/<ul>/g, '\n<ul>');
            html = html.replace(/<ol>/g, '\n<ol>');
            
            // ç¡®ä¿è¡¨æ ¼å‰åæœ‰é€‚å½“çš„é—´è·
            html = html.replace(/<\/table>/g, '</table>\n');
            html = html.replace(/<table[^>]*>/g, '\n<table>');
            
            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œï¼ˆæœ€å¤šä¿ç•™ä¸¤ä¸ªè¿ç»­ç©ºè¡Œï¼‰
            html = html.replace(/\n{3,}/g, '\n\n');
            
            return html.trim();
        }
        
        // å¤‡ç”¨Markdownè§£æå™¨ - æ”¯æŒåŸºæœ¬è¯­æ³•
        function parseMarkdownFallback(text) {
            let html = text;
            
            // 1. è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼ˆé™¤äº†å·²æœ‰çš„æ ‡ç­¾ï¼‰
            html = html.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
            
            // 2. å¤„ç†ä»£ç å— (```)
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // 3. å¤„ç†å†…è”ä»£ç  (`)
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // 4. å¤„ç†æ ‡é¢˜
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // 5. å¤„ç†åŠ ç²— (**)
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // 6. å¤„ç†æ–œä½“ (*)
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // 7. å¤„ç†é“¾æ¥ [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // 8. å¤„ç†è¡¨æ ¼
            html = parseMarkdownTable(html);
            
            // 9. å¤„ç†æ— åºåˆ—è¡¨
            html = html.replace(/^\s*[-*+]\s+(.*)$/gm, function(match, content) {
                return '<li>' + content + '</li>';
            });
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // 10. å¤„ç†æœ‰åºåˆ—è¡¨
            html = html.replace(/^\s*\d+\.\s+(.*)$/gm, function(match, content) {
                return '<li>' + content + '</li>';
            });
            html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
                // åªæ›¿æ¢è¿˜æ²¡è¢«ulåŒ…è£¹çš„li
                if (!match.includes('<ul>')) {
                    return '<ol>' + match + '</ol>';
                }
                return match;
            });
            
            // 11. å¤„ç†æ°´å¹³çº¿
            html = html.replace(/^---+$/gm, '<hr>');
            html = html.replace(/^\*\*\*+$/gm, '<hr>');
            
            // 12. å¤„ç†å¼•ç”¨
            html = html.replace(/^&gt;\s*(.*)$/gm, '<blockquote>$1</blockquote>');
            
            // 13. å¤„ç†æ®µè½å’Œæ¢è¡Œ
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            
            // 14. æ¸…ç†å¤šä½™çš„ç©ºæ®µè½
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>\s*<br>\s*<\/p>/g, '');
            
            return html;
        }
        
        // è§£æMarkdownè¡¨æ ¼
        function parseMarkdownTable(text) {
            const lines = text.split('\n');
            let html = '';
            let inTable = false;
            let tableHtml = '';
            let isHeader = true;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // æ£€æµ‹è¡¨æ ¼è¡Œï¼ˆåŒ…å« | åˆ†éš”ç¬¦ï¼‰
                if (line.includes('|')) {
                    const nextLine = lines[i + 1] ? lines[i + 1].trim() : '';
                    
                    // è·³è¿‡åˆ†éš”è¡Œï¼ˆå¦‚ |---|---|ï¼‰
                    if (line.match(/^\|?\s*[-:]+\s*\|/)) {
                        continue;
                    }
                    
                    if (!inTable) {
                        inTable = true;
                        tableHtml = '<table class="md-table">';
                        isHeader = true;
                    }
                    
                    // è§£æè¡¨æ ¼è¡Œ
                    const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
                    
                    if (isHeader) {
                        tableHtml += '<thead><tr>';
                        cells.forEach(cell => {
                            tableHtml += '<th>' + cell + '</th>';
                        });
                        tableHtml += '</tr></thead><tbody>';
                        isHeader = false;
                    } else {
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += '<td>' + cell + '</td>';
                        });
                        tableHtml += '</tr>';
                    }
                } else if (inTable) {
                    // è¡¨æ ¼ç»“æŸ
                    tableHtml += '</tbody></table>';
                    html += tableHtml;
                    tableHtml = '';
                    inTable = false;
                    html += line + '\n';
                } else {
                    html += line + '\n';
                }
            }
            
            // å¦‚æœæœ€åè¿˜åœ¨è¡¨æ ¼ä¸­ï¼Œå…³é—­è¡¨æ ¼
            if (inTable) {
                tableHtml += '</tbody></table>';
                html += tableHtml;
            }
            
            return html;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯ - å¸¦æ€è€ƒæ­¥éª¤
        function showLoadingMessage() {
            const area = document.getElementById('messagesArea');
            const loading = document.createElement('div');
            loading.className = 'message message-bot';
            loading.id = 'loadingMessage';
            loading.innerHTML = `
                <div class="bot-avatar">âœ¨</div>
                <div class="loading-message">
                    <div class="thinking-header">
                        <span class="thinking-text">æ€è€ƒä¸­</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                    <div class="thinking-steps">
                        <div class="thinking-step" data-step="0">
                            <span class="step-icon"></span>
                            <span>åˆ†æé—®é¢˜ç±»å‹</span>
                        </div>
                        <div class="thinking-step" data-step="1">
                            <span class="step-icon"></span>
                            <span>æŸ¥è¯¢çŸ¥è¯†åº“</span>
                        </div>
                        <div class="thinking-step" data-step="2">
                            <span class="step-icon"></span>
                            <span>æ£€ç´¢ç›¸å…³æ–‡çŒ®</span>
                        </div>
                        <div class="thinking-step" data-step="3">
                            <span class="step-icon"></span>
                            <span>æ•´åˆåˆ†ææ•°æ®</span>
                        </div>
                        <div class="thinking-step" data-step="4">
                            <span class="step-icon"></span>
                            <span>ç”Ÿæˆä¸“ä¸šç­”æ¡ˆ</span>
                        </div>
                    </div>
                </div>
            `;
            area.appendChild(loading);
            area.scrollTop = area.scrollHeight;
            
            // å¯åŠ¨æ€è€ƒæ­¥éª¤åŠ¨ç”»
            startThinkingAnimation();
        }
        
        // æ€è€ƒæ­¥éª¤åŠ¨ç”» - æ™ºèƒ½æ¸è¿›å¼
        let thinkingTimers = [];
        function startThinkingAnimation() {
            const steps = document.querySelectorAll('.thinking-step');
            
            // å®šä¹‰æ¯ä¸ªæ­¥éª¤çš„å»¶è¿Ÿæ—¶é—´ï¼ˆç´¯è®¡ç§’æ•°ï¼‰
            const stepTimings = [
                { delay: 0, duration: 1500 },      // æ­¥éª¤1: ç«‹å³å¼€å§‹ï¼Œ1.5ç§’åå®Œæˆ
                { delay: 1500, duration: 2000 },   // æ­¥éª¤2: 1.5ç§’åå¼€å§‹ï¼Œ2ç§’å®Œæˆ
                { delay: 3500, duration: 2500 },   // æ­¥éª¤3: 3.5ç§’åå¼€å§‹ï¼Œ2.5ç§’å®Œæˆ
                { delay: 6000, duration: 3000 },   // æ­¥éª¤4: 6ç§’åå¼€å§‹ï¼Œ3ç§’å®Œæˆ
                { delay: 9000, duration: 0 }       // æ­¥éª¤5: 9ç§’åå¼€å§‹ï¼ŒæŒç»­åˆ°ç»“æŸ
            ];
            
            steps.forEach((step, index) => {
                const timing = stepTimings[index];
                
                // å»¶è¿Ÿåæ¿€æ´»æ­¥éª¤
                const activateTimer = setTimeout(() => {
                    step.classList.add('active');
                    
                    // å¦‚æœæœ‰æŒç»­æ—¶é—´ï¼Œè®¾ç½®å®Œæˆå®šæ—¶å™¨
                    if (timing.duration > 0) {
                        const completeTimer = setTimeout(() => {
                            step.classList.remove('active');
                            step.classList.add('completed');
                        }, timing.duration);
                        thinkingTimers.push(completeTimer);
                    }
                    // å¦åˆ™ä¿æŒæ´»åŠ¨çŠ¶æ€ç›´åˆ°ç­”æ¡ˆè¿”å›
                }, timing.delay);
                
                thinkingTimers.push(activateTimer);
            });
        }

        // ç§»é™¤åŠ è½½æ¶ˆæ¯
        function removeLoadingMessage() {
            // æ¸…é™¤æ‰€æœ‰æ€è€ƒåŠ¨ç”»å®šæ—¶å™¨
            thinkingTimers.forEach(timer => clearTimeout(timer));
            thinkingTimers = [];
            
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderChats() {
            const container = document.getElementById('chatHistory');
            
            if (chats.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #9ca3af;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ’¬</div>
                        <div>æš‚æ— å¯¹è¯è®°å½•</div>
                        <div style="font-size: 12px; margin-top: 5px;">ç‚¹å‡»"æ–°å»ºå¯¹è¯"å¼€å§‹</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = chats.map(chat => `
                <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" 
                     onclick="switchChat('${chat.id}')">
                    <div style="flex: 1;">
                        <div class="history-title">${chat.title}</div>
                        <div class="history-time">${formatTime(chat.createdAt)}</div>
                    </div>
                    <button class="history-delete" onclick="deleteChat(event, '${chat.id}')" title="åˆ é™¤å¯¹è¯">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `).join('');
        }

        // åˆ‡æ¢å¯¹è¯
        function switchChat(chatId) {
            currentChatId = chatId;
            renderChats();
            renderMessages();
        }

        // åˆ é™¤å¯¹è¯
        function deleteChat(event, chatId) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘åˆ‡æ¢å¯¹è¯
            event.stopPropagation();
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
                return;
            }
            
            // æŸ¥æ‰¾è¦åˆ é™¤çš„å¯¹è¯ç´¢å¼•
            const chatIndex = chats.findIndex(c => c.id === chatId);
            if (chatIndex === -1) {
                return;
            }
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯
            if (chatId === currentChatId) {
                // åˆ é™¤å¯¹è¯
                chats.splice(chatIndex, 1);
                
                // å¦‚æœè¿˜æœ‰å…¶ä»–å¯¹è¯ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
                if (chats.length > 0) {
                    currentChatId = chats[0].id;
                } else {
                    // æ²¡æœ‰å¯¹è¯äº†ï¼Œæ¸…ç©ºå½“å‰ID
                    currentChatId = null;
                }
            } else {
                // åˆ é™¤éå½“å‰å¯¹è¯
                chats.splice(chatIndex, 1);
            }
            
            // ä¿å­˜å¹¶æ›´æ–°UI
            saveChats();
            renderChats();
            renderMessages();
        }

        // æ¸…ç©ºæ‰€æœ‰å¯¹è¯
        function clearAllChats() {
            if (chats.length === 0) {
                return;
            }
            
            // ç¡®è®¤æ¸…ç©º
            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${chats.length} ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼`)) {
                return;
            }
            
            // æ¸…ç©ºæ•°ç»„
            chats = [];
            currentChatId = null;
            
            // ä¿å­˜å¹¶æ›´æ–°UI
            saveChats();
            renderChats();
            renderMessages();
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const d = new Date(date);
            const now = new Date();
            const diff = now - d;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            return d.toLocaleDateString();
        }

        // ä¿å­˜åˆ°localStorage
        function saveChats() {
            localStorage.setItem('lfp_chats', JSON.stringify(chats));
        }

        // åŠ è½½localStorage
        function loadChats() {
            const saved = localStorage.getItem('lfp_chats');
            if (saved) {
                chats = JSON.parse(saved);
            }
        }

        // å¼‚æ­¥æ£€æŸ¥å¹¶æ·»åŠ "æŸ¥çœ‹åŸæ–‡"é“¾æ¥
        async function addViewPdfLinks(references) {
            if (!references || references.length === 0) return;
            
            for (const doi of references) {
                try {
                    // æ£€æŸ¥PDFæ˜¯å¦å­˜åœ¨
                    const response = await fetch(`/api/check_pdf/${encodeURIComponent(doi)}`);
                    const data = await response.json();
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„reference-itemå…ƒç´ 
                    const refItems = document.querySelectorAll(`.reference-item[data-doi="${doi}"]`);
                    
                    refItems.forEach(refItem => {
                        const loadingSpan = refItem.querySelector('.view-pdf-loading');
                        
                        if (data.exists) {
                            // PDFå­˜åœ¨ï¼Œæ·»åŠ "æŸ¥çœ‹åŸæ–‡"æŒ‰é’®ï¼ˆå¸¦ç¿»è¯‘åŠŸèƒ½ï¼‰
                            if (!refItem.querySelector('.view-pdf-btn')) {
                                const viewBtn = document.createElement('button');
                                viewBtn.className = 'view-pdf-btn';
                                viewBtn.onclick = (e) => {
                                    e.preventDefault();
                                    openPdfReader(doi);
                                };
                                viewBtn.title = 'åœ¨çº¿é˜…è¯»å¹¶ç¿»è¯‘';
                                viewBtn.innerHTML = 'ğŸ“„ æŸ¥çœ‹åŸæ–‡';
                                
                                // ç§»é™¤loadingï¼Œæ·»åŠ æŒ‰é’®
                                if (loadingSpan) loadingSpan.remove();
                                refItem.appendChild(viewBtn);
                            }
                        } else {
                            // PDFä¸å­˜åœ¨ï¼Œç§»é™¤loading
                            if (loadingSpan) loadingSpan.remove();
                        }
                    });
                } catch (error) {
                    console.error(`æ£€æŸ¥PDFå¤±è´¥ (${doi}):`, error);
                }
            }
        }

        // æŸ¥çœ‹PDFåŸæ–‡ï¼ˆå¤‡ç”¨å‡½æ•°ï¼‰
        function viewPdf(doi) {
            const url = `/api/view_pdf/${encodeURIComponent(doi)}`;
            window.open(url, '_blank');
        }
        
        // ğŸ¨ æ‰“å¼€PDFé˜…è¯»å™¨ï¼ˆæ–°åŠŸèƒ½ - PDF.js + ä¾§è¾¹ç¿»è¯‘ï¼‰
        async function openPdfReader(doi) {
            try {
                // åˆ›å»ºé˜…è¯»å™¨æ¨¡æ€çª—å£
                showPdfReaderModal(doi);
                
                // åŠ è½½PDF.jså¹¶æ¸²æŸ“PDF
                loadPdfWithViewer(doi);
                
            } catch (error) {
                console.error('æ‰“å¼€PDFé˜…è¯»å™¨å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
                closePdfReader();
            }
        }
        
        // æ˜¾ç¤ºPDFé˜…è¯»å™¨æ¨¡æ€çª—å£ï¼ˆæ–°ç‰ˆ - PDF.js + ä¾§è¾¹ç¿»è¯‘ï¼‰
        function showPdfReaderModal(doi) {
            const modal = document.createElement('div');
            modal.id = 'pdfReaderModal';
            modal.innerHTML = `
                <div class="pdf-reader-overlay" onclick="closePdfReader()"></div>
                <div class="pdf-reader-container-new">
                    <div class="pdf-reader-header-new">
                        <div>
                            <h2>ğŸ“„ åŸæ–‡é˜…è¯»å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰</h2>
                            <p style="font-size: 13px; color: white; opacity: 0.9; margin-top: 5px;">DOI: ${doi}</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="pdf-action-btn" onclick="downloadOriginalPdf('${doi}')" title="ä¸‹è½½åŸå§‹PDF">
                                ğŸ“¥ ä¸‹è½½PDF
                            </button>
                            <button class="pdf-action-btn" onclick="summarizeCurrentPdf()" title="ç”Ÿæˆå…¨æ–‡æ€»ç»“ï¼ˆæ’é™¤å‚è€ƒæ–‡çŒ®ï¼‰">
                                ğŸ§¾ æ–‡çŒ®æ€»ç»“
                            </button>
                            <button class="pdf-action-btn" onclick="toggleTranslationPanel()" title="æ˜¾ç¤º/éšè—ç¿»è¯‘é¢æ¿">
                                ğŸŒ ç¿»è¯‘é¢æ¿
                            </button>
                            <button class="pdf-close-btn" onclick="closePdfReader()">âœ•</button>
                        </div>
                    </div>
                    <div class="pdf-viewer-layout">
                        <!-- å·¦ä¾§ï¼šPDFæ˜¾ç¤ºåŒºï¼ˆiframeåŸç”Ÿæ–¹å¼ï¼‰ -->
                        <div class="pdf-viewer-left" id="pdfViewerLeft">
                            <div class="pdf-iframe-container">
                                <iframe id="pdfIframe" frameborder="0"></iframe>
                            </div>
                            <div class="pdf-toolbar">
                                <div class="toolbar-tip">
                                    ğŸ’¡ æç¤ºï¼šåœ¨PDFä¸­é€‰ä¸­æ–‡æœ¬åï¼Œç‚¹å‡»å³ä¾§çš„"ğŸ“‹ ç²˜è´´å¹¶ç¿»è¯‘"æŒ‰é’®
                                </div>
                            </div>
                            <div id="pdfSummaryBox" class="pdf-summary-box" style="display:none;"></div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šç¿»è¯‘é¢æ¿ -->
                        <div class="translation-panel" id="translationPanel">
                            <div class="translation-panel-header">
                                <h3>ğŸŒ æ™ºèƒ½ç¿»è¯‘</h3>
                                <button class="panel-close-btn" onclick="toggleTranslationPanel()">â†’</button>
                            </div>
                            <div class="translation-panel-content" id="translationPanelContent">
                                <div class="translation-welcome">
                                    <div class="translation-welcome-icon">ğŸš€</div>
                                    <h4>è¶…ç®€å•çš„ç¿»è¯‘æ–¹å¼</h4>
                                    <div style="text-align: left; margin: 20px 0; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                                        <p style="margin: 8px 0; font-size: 15px;"><strong>â­ æ¨èæ–¹å¼ï¼ˆæœ€å¿«ï¼‰ï¼š</strong></p>
                                        <p style="margin: 8px 0 8px 15px;">1. åœ¨å·¦ä¾§PDFä¸­é€‰ä¸­æ–‡æœ¬</p>
                                        <p style="margin: 8px 0 8px 15px;">2. å¤åˆ¶ï¼ˆCtrl/Cmd + Cï¼‰</p>
                                        <p style="margin: 8px 0 8px 15px;">3. ç‚¹å‡»ä¸‹æ–¹"ğŸ“‹ ä¸€é”®ç²˜è´´å¹¶ç¿»è¯‘"</p>
                                    </div>
                                </div>
                            </div>
                            <div class="translation-action-bar">
                                <button id="pasteAndTranslateBtn" class="translate-btn primary large pulse" onclick="pasteAndTranslate()">
                                    <span class="btn-icon">ğŸ“‹</span>
                                    <span class="btn-text">ä¸€é”®ç²˜è´´å¹¶ç¿»è¯‘</span>
                                    <span class="btn-shortcut">Ctrl+Shift+V</span>
                                </button>
                                <div class="or-divider">
                                    <span>æˆ–æ‰‹åŠ¨è¾“å…¥</span>
                                </div>
                                <div class="translation-input-container">
                                    <textarea 
                                        id="translationInput" 
                                        class="translation-input" 
                                        placeholder="ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œç²˜è´´æ–‡æœ¬..."
                                        rows="3"
                                    ></textarea>
                                </div>
                                <button id="translateInputBtn" class="translate-btn secondary" onclick="translateInputText()">
                                    <span class="btn-icon">ğŸŒ</span>
                                    <span class="btn-text">ç¿»è¯‘</span>
                                </button>
                                <div class="quick-tip">
                                    ğŸ’¡ æ¨èï¼šé€‰ä¸­PDFæ–‡æœ¬ â†’ å¤åˆ¶ â†’ ç‚¹å‡»ä¸Šæ–¹å¤§æŒ‰é’®
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
            
            // ä¿å­˜å½“å‰DOI
            window.currentViewingDoi = doi;
        }
        
        // === æ—§ç‰ˆå‡½æ•°ï¼ˆå·²å¼ƒç”¨ï¼Œä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰ ===
        // renderPdfContent, translateParagraph, translateAllParagraphs ç­‰å‡½æ•°
        // å·²è¢«æ–°çš„ PDF.js + ä¾§è¾¹ç¿»è¯‘æ–¹æ¡ˆæ›¿ä»£
        
        // ä¸‹è½½åŸå§‹PDF
        function downloadOriginalPdf(doi) {
            const url = `/api/view_pdf/${encodeURIComponent(doi)}`;
            window.open(url, '_blank');
        }

        // ç”Ÿæˆå¹¶å±•ç¤ºPDFæ€»ç»“ï¼ˆæ’é™¤å‚è€ƒæ–‡çŒ®ï¼Œå¯æŠ˜å ï¼‰
        async function summarizeCurrentPdf() {
            const doi = window.currentViewingDoi;
            if (!doi) {
                alert('è¯·å…ˆæ‰“å¼€è¦é˜…è¯»çš„PDF');
                return;
            }
            const box = document.getElementById('pdfSummaryBox');
            if (!box) return;
            // å¦‚æœå·²æœ‰å†…å®¹ä¸”å½“å‰å¯è§ï¼Œç‚¹å‡»æŒ‰é’®å³æŠ˜å 
            if (box.style.display !== 'none' && box.innerHTML.trim()) {
                box.style.display = 'none';
                return;
            }
            box.style.display = 'block';
            box.innerHTML = `
                <div class="pdf-summary-title" style="display:flex;align-items:center;justify-content:space-between;">
                    <span>ğŸ§¾ æ–‡çŒ®æ€»ç»“</span>
                    <button class="panel-close-btn" onclick="hideSummaryBox()" title="æ”¶èµ·">â†“</button>
                </div>
                <div class="pdf-summary-loading">æ­£åœ¨ç”Ÿæˆæ€»ç»“ï¼Œè¯·ç¨å€™...</div>`;
            try {
                const resp = await fetch(`/api/summarize_pdf/${encodeURIComponent(doi)}`, { method: 'POST' });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    throw new Error(data.error || 'ç”Ÿæˆæ€»ç»“å¤±è´¥');
                }
                const summary = escapeHtml(data.summary || 'æš‚æ— æ‘˜è¦');
                box.innerHTML = `
                    <div class="pdf-summary-title" style="display:flex;align-items:center;justify-content:space-between;">
                        <span>ğŸ§¾ æ–‡çŒ®æ€»ç»“</span>
                        <button class="panel-close-btn" onclick="hideSummaryBox()" title="æ”¶èµ·">â†“</button>
                    </div>
                    <div>${summary}</div>`;
            } catch (err) {
                console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', err);
                box.innerHTML = `
                    <div class="pdf-summary-title" style="display:flex;align-items:center;justify-content:space-between;">
                        <span>ğŸ§¾ æ–‡çŒ®æ€»ç»“</span>
                        <button class="panel-close-btn" onclick="hideSummaryBox()" title="æ”¶èµ·">â†“</button>
                    </div>
                    <div class="pdf-summary-loading" style="color:#b91c1c;">ç”Ÿæˆå¤±è´¥ï¼š${escapeHtml(err.message)}</div>`;
            }
        }

        function hideSummaryBox() {
            const box = document.getElementById('pdfSummaryBox');
            if (box) box.style.display = 'none';
        }
        
        // åŠ è½½PDFï¼ˆiframeæ–¹å¼ï¼‰
        async function loadPdfWithViewer(doi) {
            try {
                // ä½¿ç”¨iframeåŠ è½½PDFï¼Œæµè§ˆå™¨åŸç”Ÿæ¸²æŸ“
                const iframe = document.getElementById('pdfIframe');
                const url = `/api/view_pdf/${encodeURIComponent(doi)}`;
                iframe.src = url;
                
                // æ˜¾ç¤ºé¦–æ¬¡ä½¿ç”¨æç¤º
                showFirstTimeHint();
                
            } catch (error) {
                console.error('åŠ è½½PDFå¤±è´¥:', error);
                alert('åŠ è½½PDFå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºé¦–æ¬¡ä½¿ç”¨æç¤ºï¼ˆä»…é¦–æ¬¡ï¼‰
        function showFirstTimeHint() {
            // æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè¿‡
            if (localStorage.getItem('pdf_hint_shown_v2')) {
                return;
            }
            
            const container = document.querySelector('.pdf-iframe-container');
            const hint = document.createElement('div');
            hint.className = 'first-time-hint';
            hint.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; padding: 25px 35px; border-radius: 12px;
                            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); z-index: 10000;
                            text-align: center; animation: fadeIn 0.5s; max-width: 450px;">
                    <div style="font-size: 42px; margin-bottom: 15px;">ğŸš€âœ¨</div>
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 15px;">ä¸‰æ­¥æå®šç¿»è¯‘</div>
                    <div style="font-size: 15px; opacity: 0.95; margin-bottom: 20px; line-height: 1.8; text-align: left;">
                        <div style="margin-bottom: 12px;"><strong>æ­¥éª¤ 1ï¼š</strong> åœ¨PDFä¸­é€‰ä¸­æ–‡æœ¬</div>
                        <div style="margin-bottom: 12px;"><strong>æ­¥éª¤ 2ï¼š</strong> å¤åˆ¶ï¼ˆCtrl/Cmd + Cï¼‰</div>
                        <div style="margin-bottom: 12px;"><strong>æ­¥éª¤ 3ï¼š</strong> ç‚¹å‡»å³ä¾§ <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px;">"ğŸ“‹ ä¸€é”®ç²˜è´´å¹¶ç¿»è¯‘"</span></div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 13px; opacity: 0.9;">
                        âœ… 100%ç²¾å‡† &nbsp;|&nbsp; âš¡ è¶…å¿«é€Ÿ &nbsp;|&nbsp; ğŸ¯ å¿«æ·é”® Ctrl+Shift+V
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove(); localStorage.setItem('pdf_hint_shown_v2', 'true');"
                            style="background: white; color: #667eea; border: none; padding: 10px 24px;
                                   border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 15px;
                                   box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        çŸ¥é“äº†ï¼Œå¼€å§‹ä½¿ç”¨ ğŸš€
                    </button>
                </div>
            `;
            
            container.appendChild(hint);
            
            // 8ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (hint.parentElement) {
                    hint.style.opacity = '0';
                    hint.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        hint.remove();
                        localStorage.setItem('pdf_hint_shown_v2', 'true');
                    }, 500);
                }
            }, 8000);
        }
        
        // ç²˜è´´å¹¶ç¿»è¯‘åŠŸèƒ½
        async function pasteAndTranslate() {
            const pasteBtn = document.getElementById('pasteAndTranslateBtn');
            
            try {
                // æ£€æŸ¥å‰ªè´´æ¿APIæ˜¯å¦å¯ç”¨
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿API');
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const originalHTML = pasteBtn.innerHTML;
                pasteBtn.disabled = true;
                pasteBtn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">è¯»å–å‰ªè´´æ¿...</span>';
                
                // å°è¯•ä»å‰ªè´´æ¿è¯»å–æ–‡æœ¬
                const text = await navigator.clipboard.readText();
                
                console.log('âœ… å‰ªè´´æ¿å†…å®¹é•¿åº¦:', text ? text.length : 0);
                
                if (!text || text.trim().length === 0) {
                    pasteBtn.innerHTML = originalHTML;
                    pasteBtn.disabled = false;
                    alert('å‰ªè´´æ¿ä¸ºç©ºï¼\n\nè¯·å…ˆåœ¨PDFä¸­é€‰ä¸­æ–‡æœ¬å¹¶å¤åˆ¶ï¼ˆCtrl/Cmd + Cï¼‰');
                    return;
                }
                
                // æ¢å¤æŒ‰é’®
                pasteBtn.innerHTML = originalHTML;
                pasteBtn.disabled = false;
                
                // ç¿»è¯‘
                await performTranslation(text.trim());
                
            } catch (error) {
                console.error('âŒ è¯»å–å‰ªè´´æ¿å¤±è´¥:', error);
                
                // æ¢å¤æŒ‰é’®
                pasteBtn.disabled = false;
                
                // å‹å¥½çš„é”™è¯¯æç¤º
                const errorMsg = error.name === 'NotAllowedError' 
                    ? 'æµè§ˆå™¨æ‹’ç»è®¿é—®å‰ªè´´æ¿\n\nè¯·ä½¿ç”¨ä¸‹æ–¹è¾“å…¥æ¡†æ‰‹åŠ¨ç²˜è´´'
                    : 'æ— æ³•è¯»å–å‰ªè´´æ¿\n\nè¯·ä½¿ç”¨ä¸‹æ–¹è¾“å…¥æ¡†æ‰‹åŠ¨ç²˜è´´';
                
                alert(errorMsg);
                
                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                document.getElementById('translationInput').focus();
            }
        }
        
        // ç›‘å¬å¿«æ·é”® Ctrl/Cmd + Shift + V
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'V') {
                e.preventDefault();
                pasteAndTranslate();
            }
        });
        
        // ç¿»è¯‘è¾“å…¥æ¡†ä¸­çš„æ–‡æœ¬
        async function translateInputText() {
            const inputElement = document.getElementById('translationInput');
            const text = inputElement.value.trim();
            
            if (!text) {
                alert('è¯·å…ˆè¾“å…¥æˆ–ç²˜è´´è¦ç¿»è¯‘çš„æ–‡æœ¬');
                return;
            }
            
            await performTranslation(text);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            inputElement.value = '';
        }
        
        // æ‰§è¡Œç¿»è¯‘ï¼ˆé€šç”¨å‡½æ•°ï¼‰
        async function performTranslation(selectedText) {
            if (!selectedText) return;

            const panelContent = document.getElementById('translationPanelContent');
            const pasteBtn = document.getElementById('pasteAndTranslateBtn');
            const translateInBtn = document.getElementById('translateInputBtn');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (pasteBtn) {
                pasteBtn.disabled = true;
                pasteBtn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">ç¿»è¯‘ä¸­...</span>';
            }
            if (translateInBtn) {
                translateInBtn.disabled = true;
                translateInBtn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">ç¿»è¯‘ä¸­...</span>';
            }
            
            // æ·»åŠ ç¿»è¯‘é¡¹åˆ°é¢æ¿
            const translationItem = document.createElement('div');
            translationItem.className = 'translation-item';
            translationItem.innerHTML = `
                <div class="translation-item-header">
                    <span class="translation-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="translation-item-content">
                    <div class="translation-source">
                        <div class="lang-label">ğŸ‡¬ğŸ‡§ è‹±æ–‡</div>
                        <div class="text-content">${escapeHtml(selectedText)}</div>
                    </div>
                    <div class="translation-target">
                        <div class="lang-label">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</div>
                        <div class="text-content loading">ç¿»è¯‘ä¸­...</div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤æ¬¢è¿é¡µé¢
            const welcome = panelContent.querySelector('.translation-welcome');
            if (welcome) welcome.remove();
            
            panelContent.insertBefore(translationItem, panelContent.firstChild);
            
            try {
                // è°ƒç”¨ç¿»è¯‘API
                const response = await fetch('http://localhost:8000/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texts: [selectedText] })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const translation = data.translations[0];
                
                // æ›´æ–°ç¿»è¯‘ç»“æœ
                const targetDiv = translationItem.querySelector('.translation-target .text-content');
                targetDiv.classList.remove('loading');
                targetDiv.textContent = translation;
                
                // æ·»åŠ åŠ¨ç”»
                translationItem.classList.add('fade-in');
                
            } catch (error) {
                console.error('ç¿»è¯‘å¤±è´¥:', error);
                const targetDiv = translationItem.querySelector('.translation-target .text-content');
                targetDiv.classList.remove('loading');
                targetDiv.innerHTML = '<span style="color: #ef4444;">âŒ ç¿»è¯‘å¤±è´¥: ' + error.message + '</span>';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (pasteBtn) {
                    pasteBtn.disabled = false;
                    pasteBtn.innerHTML = '<span class="btn-icon">ğŸ“‹</span><span class="btn-text">ç²˜è´´å¹¶ç¿»è¯‘</span><span class="btn-shortcut">Ctrl+Shift+V</span>';
                }
                if (translateInBtn) {
                    translateInBtn.disabled = false;
                    translateInBtn.innerHTML = '<span class="btn-icon">ğŸŒ</span><span class="btn-text">ç¿»è¯‘</span>';
                }
            }
        }
        
        // åˆ‡æ¢ç¿»è¯‘é¢æ¿æ˜¾ç¤º/éšè—
        function toggleTranslationPanel() {
            const panel = document.getElementById('translationPanel');
            const leftPanel = document.getElementById('pdfViewerLeft');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                leftPanel.style.width = '70%';
            } else {
                panel.classList.add('hidden');
                leftPanel.style.width = '100%';
            }
        }
        
        // å…³é—­PDFé˜…è¯»å™¨
        function closePdfReader() {
            const modal = document.getElementById('pdfReaderModal');
            if (modal) {
                modal.remove();
            }
            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'auto';
            
            // æ¸…ç†å…¨å±€å˜é‡
            window.currentViewingDoi = null;
        }
    </script>
</body>
</html>

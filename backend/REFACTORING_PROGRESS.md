# é‡æ„ä»£ç ä¿®å¤è¿›åº¦æŠ¥å‘Š

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. æç¤ºè¯æ–‡ä»¶è¿ç§» âœ…
å·²æˆåŠŸå°†ä»¥ä¸‹æ ¸å¿ƒæç¤ºè¯æ–‡ä»¶ä» `otherFiles/` è¿ç§»åˆ° `code/backend/config/prompts/`ï¼š
- âœ… `system_prompt.txt` - Neo4j Cypher æŸ¥è¯¢ç”Ÿæˆæç¤ºè¯
- âœ… `synthesis_prompt_v3.txt` - ç²¾ç¡®æŸ¥è¯¢ç­”æ¡ˆåˆæˆæç¤ºè¯ï¼ˆå«ä¸¥æ ¼æ•°æ®çº¦æŸï¼‰
- âœ… `semantic_synthesis_prompt_v2.txt` - è¯­ä¹‰æœç´¢ç­”æ¡ˆåˆæˆæç¤ºè¯ï¼ˆå«æ¨æ–­æ ‡æ³¨ï¼‰
- âœ… `broad_question_synthesis_prompt.txt` - å®½æ³›é—®é¢˜ç­”æ¡ˆåˆæˆæç¤ºè¯
- âœ… `hybrid_synthesis_prompt.txt` - æ··åˆå¢å¼ºç­”æ¡ˆåˆæˆæç¤ºè¯

### 2. é…ç½®æ–‡ä»¶å®Œå–„ âœ…
- âœ… æ›´æ–° `config.env.example` æ·»åŠ ï¼š
  - DASHSCOPE_API_KEYï¼ˆé˜¿é‡Œç™¾ç‚¼ï¼ŒåŸç³»ç»Ÿä¸»è¦ä½¿ç”¨ï¼‰
  - VECTOR_DB_PATH, COMMUNITY_VECTOR_DB_PATH
  - BGE_MODEL_PATH, BGE_API_URL
  - PAPERS_DIR
  - SIMILARITY_THRESHOLD_BROAD, SIMILARITY_THRESHOLD_PRECISE
  
- âœ… æ›´æ–° `settings.py` æ·»åŠ ï¼š
  - bge_api_url
  - doi_to_pdf_mapping

### 3. ä¾èµ–é¡¹è¡¥å…… âœ…
- âœ… æ›´æ–° `requirements.txt` æ·»åŠ ï¼š
  - sentence-transformers>=2.2.0
  - requests>=2.28.0
  - FlagEmbedding>=1.2.0
  - py2neo>=2021.2.3

### 4. ä¸“å®¶ç³»ç»Ÿè¡¥å…… âœ…
- âœ… æ·»åŠ  `CommunityExpert` (community_expert.py)
- âœ… æ›´æ–° experts æ¨¡å—çš„ __init__.py

## ğŸ”„ éœ€è¦ç»§ç»­çš„ä¿®å¤ï¼ˆæ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±ï¼‰

### é«˜ä¼˜å…ˆçº§ï¼ˆç³»ç»Ÿæ— æ³•æ­£å¸¸è¿è¡Œï¼‰

#### 1. æ·»åŠ ç¼ºå¤±çš„æ ¸å¿ƒç»„ä»¶
éœ€è¦ä» otherFiles ç§»æ¤ä»¥ä¸‹å…³é”®ç»„ä»¶ï¼š
- âŒ `CommanderAgent` - å†³ç­–æŒ‡æŒ¥å®˜ï¼ˆæ™ºèƒ½åˆ¤æ–­æŸ¥è¯¢æ¨¡å¼ï¼‰
- âŒ `HybridQueryAgent` - æ··åˆæŸ¥è¯¢ä»£ç†ï¼ˆNeo4j + è¯­ä¹‰æœç´¢ç»“åˆï¼‰
- âŒ `GenerationDrivenRAG` - ç”Ÿæˆé©±åŠ¨æ£€ç´¢ç³»ç»Ÿï¼ˆä¸¤é˜¶æ®µRAGï¼‰
- âŒ `DualRetrievalAgent` - åŒå¬å›æ£€ç´¢ä»£ç†
- âŒ `Neo4jTwoStageOptimizer` - Neo4j ä¸¤é˜¶æ®µæŸ¥è¯¢ä¼˜åŒ–å™¨
- âŒ `IntegratedAgent` - é›†æˆæ™ºèƒ½ä»£ç†ï¼ˆç»Ÿä¸€å…¥å£ï¼‰

#### 2. é‡æ„ API routes.py çš„ /ask_stream ç«¯ç‚¹
å½“å‰é—®é¢˜ï¼š
- âŒ ç»•è¿‡äº†æœåŠ¡å±‚ï¼Œç›´æ¥æ“ä½œ Repository
- âŒ æ²¡æœ‰ä½¿ç”¨ä¸“å®¶ç³»ç»Ÿ
- âŒ ç¡¬ç¼–ç äº†å¤§é‡ä¸šåŠ¡é€»è¾‘
- âŒ PDF åŒ¹é…é€»è¾‘ä½æ•ˆ

éœ€è¦æ”¹ä¸ºï¼š
- âœ… ä½¿ç”¨ IntegratedAgent ç»Ÿä¸€å¤„ç†
- âœ… æ™ºèƒ½è·¯ç”±åˆ°åˆé€‚çš„ä¸“å®¶ç³»ç»Ÿ
- âœ… ä½¿ç”¨æœåŠ¡å±‚å°è£…ä¸šåŠ¡é€»è¾‘
- âœ… æ”¯æŒå¤šç§æŸ¥è¯¢æ¨¡å¼ï¼ˆPDFç›´æ¥æŸ¥è¯¢ã€ç”Ÿæˆé©±åŠ¨æ£€ç´¢ç­‰ï¼‰

#### 3. ä¸“å®¶ç³»ç»ŸåŠŸèƒ½å¢å¼º
éœ€è¦å¢å¼ºç°æœ‰ä¸“å®¶ç³»ç»Ÿï¼š

**QueryExpert éœ€è¦æ·»åŠ **ï¼š
- âŒ PDF åŸæ–‡åŠ è½½å’Œæ•°æ®è¡¥å……
- âŒ ä¸¤é˜¶æ®µæŸ¥è¯¢ä¼˜åŒ–
- âŒ ææ–™ç±»å‹è¿‡æ»¤éªŒè¯
- âŒ å•ä½æ£€æŸ¥å’ŒéªŒè¯

**SemanticExpert éœ€è¦æ·»åŠ **ï¼š
- âŒ ç›¸ä¼¼åº¦è¿‡æ»¤ï¼ˆåŠ¨æ€é˜ˆå€¼ï¼‰
- âŒ PDF åŸæ–‡åŠ è½½
- âŒ å®½æ³›é—®é¢˜å¤„ç†ï¼ˆæ–¹æ¡ˆäº”ï¼šLLMæ¡†æ¶+æ–‡çŒ®è¡¥å……ï¼‰

#### 4. æœåŠ¡å±‚åŠŸèƒ½å®Œå–„
**LLMService éœ€è¦æ·»åŠ **ï¼š
- âŒ åŠ è½½å’Œç®¡ç†æç¤ºè¯æ¨¡æ¿çš„æ–¹æ³•
- âŒ æç¤ºè¯æ¨¡æ¿çš„ç¼“å­˜æœºåˆ¶

**VectorService éœ€è¦æ·»åŠ **ï¼š
- âŒ aggregate_knowledge æ–¹æ³•ï¼ˆèšåˆæ–‡çŒ®å’Œç¤¾åŒºçŸ¥è¯†ï¼‰
- âŒ å…³é”®è¯åŒ¹é…é™çº§æ–¹æ¡ˆ

**Neo4jService éœ€è¦æ·»åŠ **ï¼š
- âŒ ä¸¤é˜¶æ®µæŸ¥è¯¢ä¼˜åŒ–æ”¯æŒ
- âŒ æŸ¥è¯¢ç»“æœéªŒè¯ï¼ˆå•ä½æ£€æŸ¥ã€ææ–™ç±»å‹æ£€æŸ¥ï¼‰

### ä¸­ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½å®Œæ•´æ€§ï¼‰

#### 5. æ·»åŠ å·¥å…·ç±»æ¨¡å—
éœ€è¦ä» otherFiles æ·»åŠ ï¼š
- âŒ `pdf_loader.py` çš„å®Œæ•´å®ç°ï¼ˆPDF æå–ã€å‚è€ƒæ–‡çŒ®æ’é™¤ç­‰ï¼‰
- âŒ `cypher_utils.py` çš„å·¥å…·å‡½æ•°
- âŒ `formatters.py` çš„æ ¼å¼åŒ–å·¥å…·

#### 6. å®ç°å•ä¾‹æœåŠ¡ç®¡ç†
å½“å‰é—®é¢˜ï¼š
- âŒ main.py ä¸­åˆå§‹åŒ–ä¸€æ¬¡
- âŒ routes.py ä¸­åˆåˆå§‹åŒ–ä¸€æ¬¡ï¼ˆæ‡’åŠ è½½ï¼‰
- âŒ æ¯ä¸ªç«¯ç‚¹å¯èƒ½é‡å¤åˆ›å»ºå®ä¾‹

éœ€è¦æ”¹ä¸ºï¼š
- âœ… ç»Ÿä¸€çš„æœåŠ¡ç®¡ç†å™¨
- âœ… å…¨å±€å•ä¾‹æ¨¡å¼
- âœ… é¿å…é‡å¤åˆå§‹åŒ–

#### 7. æ·»åŠ å…¶ä»–ç¼ºå¤±ç«¯ç‚¹
åŸç³»ç»Ÿæœ‰ä½†é‡æ„åç¼ºå¤±ï¼š
- âŒ `/upload` - PDF ä¸Šä¼ ç«¯ç‚¹
- âŒ `/pdf/view` - PDF æŸ¥çœ‹ç«¯ç‚¹
- âŒ `/integrated_query` - é›†æˆæŸ¥è¯¢ç«¯ç‚¹ï¼ˆä½¿ç”¨ IntegratedAgentï¼‰

### ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–å’Œå®Œå–„ï¼‰

#### 8. æ·»åŠ ç¿»è¯‘ç¼“å­˜æœºåˆ¶
åŸç³»ç»Ÿæœ‰ä½†é‡æ„åç¼ºå¤±ï¼š
- âŒ TranslationCache ç±»
- âŒ SmartTranslator ç±»

#### 9. æ·»åŠ ä¸Šä¸‹æ–‡è§£æ
åŸç³»ç»Ÿæ”¯æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç†è§£ï¼š
- âŒ need_context_resolution() å‡½æ•°
- âŒ resolve_context_question() å‡½æ•°

#### 10. æ·»åŠ  PDF æ™ºèƒ½åŒ¹é…
åŸç³»ç»Ÿçš„é«˜çº§åŠŸèƒ½ï¼š
- âŒ DOI åˆ° PDF çš„æ˜ å°„ç¼“å­˜
- âŒ æ–‡ä»¶åæ™ºèƒ½åŒ¹é…
- âŒ PDF å†…å®¹é¢„è§ˆ

## ğŸ“ ä¿®å¤å»ºè®®å’Œä¼˜å…ˆçº§

### ç«‹å³ä¿®å¤ï¼ˆé˜»å¡æ€§é—®é¢˜ï¼‰
1. **æ·»åŠ  IntegratedAgent**ï¼ˆæœ€é‡è¦ï¼‰
   - è¿™æ˜¯ç»Ÿä¸€å…¥å£ï¼Œæ‰€æœ‰æŸ¥è¯¢éƒ½åº”è¯¥é€šè¿‡å®ƒ
   - åŒ…å«æ™ºèƒ½è·¯ç”±é€»è¾‘
   - åè°ƒå„ä¸ªä¸“å®¶ç³»ç»Ÿ

2. **é‡æ„ /ask_stream ç«¯ç‚¹**
   - ä½¿ç”¨ IntegratedAgent æ›¿ä»£å½“å‰çš„ç¡¬ç¼–ç é€»è¾‘
   - æ¢å¤æµå¼è¾“å‡ºçš„å®Œæ•´æµç¨‹

3. **å®Œå–„ QueryExpert å’Œ SemanticExpert**
   - æ·»åŠ  PDF åŸæ–‡åŠ è½½
   - æ·»åŠ ç­”æ¡ˆåˆæˆé€»è¾‘
   - ä½¿ç”¨æ­£ç¡®çš„æç¤ºè¯æ¨¡æ¿

### çŸ­æœŸä¿®å¤ï¼ˆ1-2å¤©ï¼‰
4. æ·»åŠ  GenerationDrivenRAG
5. æ·»åŠ  HybridQueryAgent å’Œ CommanderAgent
6. å®ç°å•ä¾‹æœåŠ¡ç®¡ç†
7. å®Œå–„å·¥å…·ç±»æ¨¡å—

### ä¸­æœŸä¼˜åŒ–ï¼ˆ3-7å¤©ï¼‰
8. æ·»åŠ ç¿»è¯‘ç¼“å­˜
9. æ·»åŠ ä¸Šä¸‹æ–‡è§£æ
10. æ·»åŠ å…¶ä»–ç«¯ç‚¹ï¼ˆupload, pdf/view ç­‰ï¼‰

## ğŸ” å…³é”®ä¿®å¤ç¤ºä¾‹

### ç¤ºä¾‹1: QueryExpert éœ€è¦æ·»åŠ çš„æ ¸å¿ƒæ–¹æ³•

```python
def _synthesize_answer(self, user_question: str, query_result: List[Dict]) -> str:
    """ç­”æ¡ˆåˆæˆï¼ˆä½¿ç”¨ synthesis_prompt_v3.txtï¼‰"""
    # 1. ä»æŸ¥è¯¢ç»“æœä¸­æå– DOI
    # 2. åŠ è½½ PDF åŸæ–‡
    # 3. ä½¿ç”¨ synthesis_prompt_v3.txt æ„å»ºæç¤ºè¯
    # 4. è°ƒç”¨ LLM ç”Ÿæˆç­”æ¡ˆ
    # 5. è¿”å›ç­”æ¡ˆ
    
def _load_pdf_by_doi(self, doi: str) -> Optional[str]:
    """æ ¹æ® DOI åŠ è½½ PDF åŸæ–‡"""
    # 1. ä» doi_to_pdf_mapping.json æŸ¥æ‰¾
    # 2. ä½¿ç”¨ PDFLoader æå–æ–‡æœ¬
    # 3. è¿”å› PDF å†…å®¹
```

### ç¤ºä¾‹2: /ask_stream åº”è¯¥æ”¹æˆçš„æ ·å­

```python
@api.route('/ask_stream', methods=['POST'])
def ask_question_stream():
    def generate():
        # 1. è·å–é—®é¢˜
        question = data.get('question')
        
        # 2. ä½¿ç”¨ IntegratedAgentï¼ˆä¸æ˜¯ç›´æ¥æ“ä½œ Repositoryï¼‰
        integrated_agent = get_integrated_agent()
        
        # 3. æ™ºèƒ½è·¯ç”±å’ŒæŸ¥è¯¢
        for chunk in integrated_agent.query_stream(question):
            yield f"data: {json.dumps(chunk)}\n\n"
    
    return Response(generate(), mimetype='text/event-stream')
```

## ğŸ“Š ä¿®å¤å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | éš¾åº¦ | ä¼˜å…ˆçº§ |
|------|---------|------|--------|
| æ·»åŠ  IntegratedAgent | 2-3h | ä¸­ | ğŸ”´ æœ€é«˜ |
| é‡æ„ /ask_stream | 2-3h | ä¸­ | ğŸ”´ æœ€é«˜ |
| å®Œå–„ QueryExpert | 3-4h | é«˜ | ğŸ”´ æœ€é«˜ |
| å®Œå–„ SemanticExpert | 2-3h | ä¸­ | ğŸ”´ æœ€é«˜ |
| æ·»åŠ  GenerationDrivenRAG | 4-5h | é«˜ | ğŸŸ¡ é«˜ |
| æ·»åŠ å…¶ä»–æ ¸å¿ƒç»„ä»¶ | 3-4h | ä¸­ | ğŸŸ¡ é«˜ |
| å®ç°å•ä¾‹ç®¡ç† | 1-2h | ä½ | ğŸŸ¡ é«˜ |
| å®Œå–„å·¥å…·ç±» | 2-3h | ä½ | ğŸŸ¢ ä¸­ |
| æ·»åŠ å…¶ä»–ç«¯ç‚¹ | 2-3h | ä½ | ğŸŸ¢ ä¸­ |
| ç¿»è¯‘ç¼“å­˜ç­‰ä¼˜åŒ– | 2-3h | ä½ | âšª ä½ |

**æ€»è®¡**: çº¦ 23-33 å°æ—¶å·¥ä½œé‡

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

1. ç«‹å³åˆ›å»º `IntegratedAgent` ç±»
2. ä» otherFiles/integrated_agent.py ç§»æ¤æ ¸å¿ƒé€»è¾‘
3. é‡æ„ routes.py çš„ /ask_stream ä½¿ç”¨ IntegratedAgent
4. å®Œå–„ QueryExpert æ·»åŠ  PDF åŠ è½½å’Œç­”æ¡ˆåˆæˆ
5. å®Œå–„ SemanticExpert æ·»åŠ ç›¸ä¼¼åº¦è¿‡æ»¤å’Œ PDF åŠ è½½
6. æµ‹è¯•æ ¸å¿ƒæµç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œ
7. é€æ­¥æ·»åŠ å…¶ä»–ç¼ºå¤±ç»„ä»¶

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ä¸è¦ç ´åç°æœ‰åŠŸèƒ½**ï¼šåœ¨æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œç¡®ä¿ä¸å½±å“å·²æœ‰çš„ç«¯ç‚¹
2. **ä¿æŒåˆ†å±‚æ¶æ„**ï¼šéµå®ˆ Controller â†’ Service â†’ Repository çš„åˆ†å±‚åŸåˆ™
3. **ä½¿ç”¨æç¤ºè¯æ¨¡æ¿**ï¼šæ‰€æœ‰ LLM è°ƒç”¨éƒ½åº”è¯¥ä½¿ç”¨ config/prompts/ ä¸­çš„æ¨¡æ¿
4. **æµ‹è¯•é©±åŠ¨**ï¼šæ¯å®Œæˆä¸€ä¸ªç»„ä»¶ï¼Œç«‹å³æµ‹è¯•å…¶åŠŸèƒ½
5. **æ—¥å¿—è®°å½•**ï¼šæ·»åŠ è¯¦ç»†çš„æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œè¿½è¸ªé—®é¢˜
